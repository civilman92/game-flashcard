<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0;
            --success: #66BB6A;
            --danger: #EF5350;
            --bg: #F5F7FA;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        body { background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }

        .container {
            background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 900px; width: 100%; padding: 30px; position: relative;
        }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .score-board {
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; 
            background: #f8f9fa; padding: 10px; border-radius: 12px;
        }
        .balloon {
            width: 20px; height: 25px; background: #4FC3F7; border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .balloon.popped { transform: scale(0); opacity: 0; }
        .balloon.missed { background: #CFD8DC; opacity: 0.5; transform: scale(0.8); }

        .panel { display: none; }
        .active { display: block; }

        /* åœ–ç‰‡å®¹å™¨ - æ”¹é€²ç‰ˆ */
        .image-container { 
            width: 100%; height: 350px; background: linear-gradient(45deg, #f0f0f0, #e0e0e0); 
            border-radius: 15px; margin-bottom: 20px; display: flex; align-items: center; 
            justify-content: center; overflow: hidden; border: 3px solid #eee;
            position: relative;
        }
        .image-container img { 
            max-width: 95%; max-height: 95%; object-fit: contain; 
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .image-placeholder {
            font-size: 48px; color: #999; text-align: center;
        }
        .image-loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #666;
        }

        .chinese-hint { font-size: 36px; font-weight: bold; text-align: center; margin-bottom: 10px; color: #333; }
        
        .letter-inputs { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .letter-box {
            width: 50px; height: 65px; border: 3px solid #CFD8DC; border-radius: 10px;
            text-align: center; font-size: 28px; font-weight: bold; text-transform: uppercase;
            outline: none; transition: 0.2s;
        }
        .letter-box:focus { border-color: var(--primary); background: #E8EAF6; }
        .letter-box.correct { background: var(--success); color: white; border-color: var(--success); }
        .letter-box.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        .dart { position: absolute; font-size: 30px; pointer-events: none; transition: all 0.6s ease-in; z-index: 100; display: none; }

        .btn { padding: 12px 35px; border: none; border-radius: 30px; font-size: 18px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 10px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(92, 107, 192, 0.4); }
        .btn-speaker { background: #FFF176; color: #333; font-size: 20px; }

        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th, .summary-table td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        .status-correct { color: var(--success); font-weight: bold; }
        .status-wrong { color: var(--danger); font-weight: bold; }
        
        textarea { width: 100%; height: 200px; padding: 15px; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="dart" class="dart">ğŸ¯</div>

    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 10px;">ğŸ“š é¡Œåº«è¨­å®š (æ”¯æ´åœ–ç‰‡è‡ªå‹•æœå°‹)</h2>
        <textarea id="wordInput" placeholder="æ ¼å¼ï¼šå–®å­—|ä¸­æ–‡&#10;ä¾‹å¦‚ï¼šapple|è˜‹æœ">apple|è˜‹æœ
banana|é¦™è•‰
computer|é›»è…¦
</textarea>
        <button class="btn btn-primary" style="display: block; margin: 0 auto;" onclick="initGame()">é–‹å§‹æŒ‘æˆ° (20é¡Œ)</button>
    </div>

    <div id="gamePanel" class="panel">
        <div class="header">
            <div>
                <h3 id="questionTitle">ç¬¬ 1 é¡Œ</h3>
                <p style="color: #777;">é€²åº¦: <span id="progressText">0/20</span></p>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-container" id="imageContainer">
            <div class="image-loading">ğŸ” æœå°‹åœ–ç‰‡ä¸­...</div>
            <img id="wordImage" src="" alt="å–®å­—åœ–ç‰‡" style="display: none;">
            <div id="imagePlaceholder" class="image-placeholder" style="display: none;">ğŸ“·</div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        
        <div style="text-align: center;">
            <button class="btn btn-primary" id="submitBtn" onclick="handleCheck()">æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-primary" id="nextBtn" style="display:none; background:#546E7A;" onclick="goNext()">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="resultPanel" class="panel">
        <h2 style="text-align: center;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div style="max-height: 450px; overflow-y: auto; margin: 20px 0;">
            <table class="summary-table" id="summaryTable">
                <thead>
                    <tr><th>å–®å­—</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-primary" style="display: block; margin: 0 auto;" onclick="location.reload()">å›åˆ°é¦–é </button>
    </div>
</div>

<script>
    const defaultWords = "apple|è˜‹æœ\nbanana|é¦™è•‰\ncomputer|é›»è…¦\nelephant|å¤§è±¡\nflower|èŠ±æœµ\nguitar|å‰ä»–\nhappiness|å¿«æ¨‚\ninternet|ç¶²è·¯\njacket|å¤¾å…‹\nkitchen|å»šæˆ¿\nlemon|æª¸æª¬\nmountain|å±±è„ˆ\nnotebook|ç­†è¨˜æœ¬\norange|æ©˜å­\npencil|é‰›ç­†\nqueen|çš‡å\nrabbit|å…”å­\nschool|å­¸æ ¡\ntiger|è€è™\numbrella|é›¨å‚˜";

    let wordBank = [];
    let gameList = [];
    let currentIdx = 0;
    let results = [];

    document.getElementById('wordInput').value = defaultWords;

    // ğŸ”§ æ”¹é€²ç‰ˆåœ–ç‰‡è¼‰å…¥å‡½æ•¸ï¼ˆ3å±¤å‚™æ´ï¼‰
    function loadWordImage(word) {
        const img = document.getElementById('wordImage');
        const container = document.getElementById('imageContainer');
        const placeholder = document.getElementById('imagePlaceholder');
        const loading = container.querySelector('.image-loading');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        img.style.display = 'none';
        placeholder.style.display = 'none';
        loading.style.display = 'block';

        let attempts = 0;
        const maxAttempts = 3;
        const sources = [
            `https://source.unsplash.com/featured/800x600?${word}&sig=${Date.now()}`,
            `https://picsum.photos/seed/${word}/800/600`,
            `https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop&crop=center&${word}`
        ];

        function tryNextSource() {
            if (attempts >= maxAttempts) {
                // å…¨éƒ¨å¤±æ•—ï¼Œé¡¯ç¤ºplaceholder
                loading.style.display = 'none';
                placeholder.innerHTML = `ğŸ“¸ ${word}`;
                placeholder.style.display = 'block';
                return;
            }

            img.src = sources[attempts];
            attempts++;
        }

        img.onload = () => {
            loading.style.display = 'none';
            img.style.display = 'block';
        };

        img.onerror = () => {
            setTimeout(tryNextSource, 500);
        };

        tryNextSource();
    }

    function initGame() {
        const raw = document.getElementById('wordInput').value.trim();
        wordBank = raw.split('\n').map(line => {
            const parts = line.split('|');
            return { en: parts[0]?.trim().toLowerCase(), ch: parts[1]?.trim() };
        }).filter(item => item.en && item.ch);

        if(wordBank.length < 20) {
            alert("è«‹è‡³å°‘è¼¸å…¥ 20 å€‹å–®å­—ï¼");
            return;
        }

        gameList = [...wordBank].sort(() => Math.random() - 0.5).slice(0, 20);
        
        const board = document.getElementById('scoreBoard');
        board.innerHTML = '';
        for(let i=0; i<20; i++) {
            const b = document.createElement('div');
            b.className = 'balloon';
            b.id = `balloon-${i}`;
            board.appendChild(b);
        }

        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        loadQuestion();
    }

    function loadQuestion() {
        const q = gameList[currentIdx];
        document.getElementById('questionTitle').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
        document.getElementById('progressText').textContent = `${currentIdx + 1}/20`;
        document.getElementById('chineseHint').textContent = q.ch;
        
        // ğŸš€ ä½¿ç”¨æ”¹é€²ç‰ˆåœ–ç‰‡è¼‰å…¥
        loadWordImage(q.en);
        
        setTimeout(() => pronounceWord(), 800);

        const container = document.getElementById('letterInputs');
        container.innerHTML = '';
        
        q.en.split('').forEach((char, i) => {
            if(char === ' ' || char === '-') {
                const s = document.createElement('span');
                s.textContent = char;
                s.style.width = '20px';
                container.appendChild(s);
            } else {
                const input = document.createElement('input');
                input.className = 'letter-box';
                input.maxLength = 1;
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' || e.key === 'Delete') {
                        if (input.value === '') {
                            const prev = input.previousElementSibling;
                            if (prev && prev.tagName === 'INPUT') {
                                prev.focus();
                                prev.value = '';
                            }
                        } else {
                            input.value = '';
                        }
                        e.preventDefault();
                    }
                });

                input.addEventListener('input', (e) => {
                    if (input.value) {
                        const next = input.nextElementSibling;
                        if (next && next.tagName === 'INPUT') next.focus();
                    }
                });

                container.appendChild(input);
            }
        });
        
        document.getElementById('submitBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';
        setTimeout(() => container.querySelector('input')?.focus(), 1200);
    }

    function handleCheck() {
        const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = "";
        let inputIdx = 0;
        
        q.en.split('').forEach(char => {
            if(char === ' ' || char === '-') userAns += char;
            else userAns += inputs[inputIdx++].value.toLowerCase();
        });

        const isCorrect = (userAns === q.en);
        results.push({ q: q.en, ch: q.ch, user: userAns, status: isCorrect });

        inputIdx = 0;
        inputs.forEach(box => {
            box.classList.add(isCorrect ? 'correct' : 'wrong');
            box.disabled = true;
        });

        const dart = document.getElementById('dart');
        const target = document.getElementById(`balloon-${currentIdx}`);
        const rect = target.getBoundingClientRect();
        
        dart.style.display = 'block';
        dart.style.left = '50%';
        dart.style.top = '80%';
        dart.style.opacity = '1';

        setTimeout(() => {
            if(isCorrect) {
                dart.style.left = rect.left + 'px';
                dart.style.top = rect.top + 'px';
                setTimeout(() => {
                    target.classList.add('popped');
                    dart.style.opacity = '0';
                }, 500);
            } else {
                dart.style.left = (rect.left - 100) + 'px';
                dart.style.top = (rect.top - 50) + 'px';
                setTimeout(() => {
                    target.classList.add('missed');
                    dart.style.opacity = '0';
                }, 500);
            }
        }, 50);

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'block';
    }

    function pronounceWord() {
        const q = gameList[currentIdx];
        const msg = new SpeechSynthesisUtterance(q.en);
        msg.lang = 'en-US';
        msg.rate = 0.8;
        window.speechSynthesis.speak(msg);
    }

    function goNext() {
        currentIdx++;
        if(currentIdx < 20) loadQuestion();
        else showFinalResults();
    }

    function showFinalResults() {
        document.getElementById('gamePanel').classList.remove('active');
        document.getElementById('resultPanel').classList.add('active');
        
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        results.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.q;
            row.insertCell(1).textContent = r.q;
            row.insertCell(2).textContent = r.user || "(æœªå¡«å¯«)";
            const sCell = row.insertCell(3);
            sCell.textContent = r.status ? "âœ… Correct" : "âŒ Wrong";
            sCell.className = r.status ? "status-correct" : "status-wrong";
        });
    }
</script>

</body>
</html>
