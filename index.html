<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0;
            --success: #66BB6A;
            --danger: #EF5350;
            --bg: #F5F7FA;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            max-width: 900px;
            width: 100%;
            padding: 20px 24px;
        }

        /* é€²åº¦èˆ‡è¨ˆåˆ†æ¿ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-info {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .score-board {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .score-icon { font-size: 22px; }
        .trophy { color: #f39c12; }
        .skull { color: #e74c3c; }

        .panel { display: none; }
        .active { display: block; }

        /* åœ–ç‰‡å®¹å™¨ */
        .image-container {
            width: 100%;
            max-width: 520px;
            height: 260px;
            background: #f5f5f5;
            border-radius: 16px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .chinese-hint {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
            color: #333;
        }

        /* å­—æ¯è¼¸å…¥æ ¼ */
        .letter-inputs {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 14px 0;
            flex-wrap: wrap;
        }
        .letter-box {
            width: 46px;
            height: 58px;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            outline: none;
            background: white;
        }
        .letter-box.correct { background: var(--success); color: white; border-color: var(--success); }
        .letter-box.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* çµæœè¨Šæ¯ */
        .result-message {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 8px 0;
            min-height: 35px;
            padding: 8px;
            border-radius: 10px;
        }
        .result-correct { background: #d4edda; color: #155724; }
        .result-wrong { background: #f8d7da; color: #721c24; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 26px;
            border: none;
            border-radius: 22px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-speaker { background: #fff176; margin-bottom: 10px; }

        /* çµæœé é¢æ­£ç¢ºç‡ */
        .accuracy-badge {
            font-size: 40px;
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        .summary-table th, .summary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        .status-correct { color: var(--success); font-weight: 700; }
        .status-wrong { color: var(--danger); font-weight: 700; }
    </style>
</head>
<body>
<div class="container">
    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“š é¸æ“‡é¡Œçµ„é–‹å§‹æŒ‘æˆ°</h2>
        <div id="groupSelection" style="min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px;">
            è¼‰å…¥ä¸­...
        </div>
        <div style="text-align: center;">
            <button class="btn btn-primary" id="startBtn" onclick="initGame()" disabled>ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="gamePanel" class="panel">
        <div class="header">
            <div class="progress-info">
                <div id="questionNum" style="font-size: 20px;">ç¬¬ 1 é¡Œ</div>
                <div>é€²åº¦: <span id="progressText">0/0</span></div>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-container">
            <img id="wordImage" src="" alt="" style="display:none;">
            <div id="placeholder">ğŸ“·</div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š è®€éŸ³</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        <div class="result-message" id="resultMessage"></div>

        <div style="text-align:center;">
            <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">ç¢ºèªç­”æ¡ˆ</button>
        </div>
    </div>

    <div id="resultPanel" class="panel">
        <h2 style="text-align: center;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div id="accuracyDisplay" class="accuracy-badge"></div>
        <div style="max-height: 300px; overflow-y: auto;">
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>å–®å­—</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:3000/api';
    let allGroups = [], wordBank = [], gameList = [], currentIdx = 0;
    let results = [], scores = [], answerChecked = false;

    // è¼‰å…¥å¾Œå°é¡Œçµ„
    async function loadGroups() {
        const panel = document.getElementById('groupSelection');
        try {
            const res = await fetch(`${API_BASE}/groups`);
            allGroups = await res.json();
            panel.innerHTML = '';
            allGroups.forEach((g, idx) => {
                const div = document.createElement('div');
                div.innerHTML = `<label><input type="checkbox" data-idx="${idx}" onchange="checkStartBtn()"> ${g.name} (${g.words.length} è©)</label>`;
                panel.appendChild(div);
            });
        } catch (e) { panel.innerHTML = 'ç„¡æ³•é€£ç·šä¼ºæœå™¨'; }
    }

    function checkStartBtn() {
        const selected = document.querySelectorAll('#groupSelection input:checked');
        document.getElementById('startBtn').disabled = selected.length === 0;
    }

    function initGame() {
        wordBank = [];
        document.querySelectorAll('#groupSelection input:checked').forEach(input => {
            wordBank.push(...allGroups[input.dataset.idx].words);
        });
        gameList = wordBank.sort(() => Math.random() - 0.5).slice(0, 20);
        
        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        loadQuestion();
    }

    function loadQuestion() {
        const q = gameList[currentIdx];
        answerChecked = false;
        document.getElementById('questionNum').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
        document.getElementById('progressText').textContent = `${currentIdx + 1}/${gameList.length}`;
        document.getElementById('chineseHint').textContent = q.ch;
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('resultMessage').className = 'result-message';
        document.getElementById('actionBtn').textContent = 'ç¢ºèªç­”æ¡ˆ';

        const container = document.getElementById('letterInputs');
        container.innerHTML = '';
        
        q.en.split('').forEach((char, i) => {
            if (char === ' ') {
                const s = document.createElement('span');
                s.style.width = '20px';
                container.appendChild(s);
            } else {
                const input = document.createElement('input');
                input.className = 'letter-box';
                input.maxLength = 1;
                input.dataset.idx = i;
                input.oninput = (e) => {
                    if(e.target.value) {
                        const next = e.target.nextElementSibling;
                        if(next) next.focus();
                    }
                };
                // éµç›¤äº‹ä»¶ç›£è½
                input.onkeydown = (e) => {
                    if (e.key === 'Backspace' && !e.target.value) {
                        const prev = e.target.previousElementSibling;
                        if(prev) prev.focus();
                    }
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleAction(); // è§¸ç™¼çµ±ä¸€çš„å‹•ä½œè™•ç†
                    }
                };
                container.appendChild(input);
            }
        });
        container.firstChild.focus();
        fetchImage(q.en);
    }

    // é—œéµéœ€æ±‚ 1ï¼šè™•ç† Enter å‹•ä½œ
    function handleAction() {
        if (!answerChecked) {
            checkAnswer();
        } else {
            goNext();
        }
    }

    function checkAnswer() {
        const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = '';
        
        // çµ„åˆä½¿ç”¨è€…ç­”æ¡ˆ
        let inputIdx = 0;
        q.en.split('').forEach(char => {
            if(char === ' ') userAns += ' ';
            else userAns += (inputs[inputIdx++].value || '').toLowerCase();
        });

        const isCorrect = userAns === q.en.toLowerCase();
        answerChecked = true;
        
        // æ›´æ–° UI
        inputs.forEach((input, i) => {
            input.disabled = true;
            const correctChar = q.en.replace(/ /g, '')[i].toLowerCase();
            input.classList.add(input.value.toLowerCase() === correctChar ? 'correct' : 'wrong');
        });

        const msg = document.getElementById('resultMessage');
        if (isCorrect) {
            msg.textContent = "ğŸ‰ å¤ªæ£’äº†ï¼(å†æŒ‰ä¸€æ¬¡ Enter ç¹¼çºŒ)";
            msg.className = "result-message result-correct";
            scores.push('ğŸ†');
        } else {
            msg.textContent = `âŒ æ­£ç¢ºç­”æ¡ˆæ˜¯: ${q.en.toUpperCase()} (å†æŒ‰ä¸€æ¬¡ Enter ç¹¼çºŒ)`;
            msg.className = "result-message result-wrong";
            scores.push('ğŸ’€');
        }
        
        results.push({ en: q.en, user: userAns, status: isCorrect });
        updateScoreBoard();
        document.getElementById('actionBtn').textContent = 'ä¸‹ä¸€é¡Œ';
        pronounceWord(); // è‡ªå‹•ç™¼éŸ³
    }

    function goNext() {
        currentIdx++;
        if (currentIdx < gameList.length) {
            loadQuestion();
        } else {
            showFinalResults();
        }
    }

    // é—œéµéœ€æ±‚ 2ï¼šè¨ˆç®—æ­£ç¢ºç‡
    function showFinalResults() {
        document.getElementById('gamePanel').classList.remove('active');
        document.getElementById('resultPanel').classList.add('active');
        
        const correctCount = results.filter(r => r.status).length;
        const totalCount = results.length;
        const accuracy = Math.round((correctCount / totalCount) * 100);
        
        document.getElementById('accuracyDisplay').innerHTML = `
            æ­£ç¢ºç‡ï¼š${accuracy}%<br>
            <span style="font-size:18px; color:#555;">(${correctCount} / ${totalCount} é¡Œ)</span>
        `;

        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        results.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.en;
            row.insertCell(1).textContent = r.user;
            const sCell = row.insertCell(2);
            sCell.textContent = r.status ? 'âœ…' : 'âŒ';
            sCell.className = r.status ? 'status-correct' : 'status-wrong';
        });
    }

    function updateScoreBoard() {
        document.getElementById('scoreBoard').innerHTML = scores.map(s => `<span class="score-icon ${s==='ğŸ†'?'trophy':'skull'}">${s}</span>`).join('');
    }

    function pronounceWord() {
        const msg = new SpeechSynthesisUtterance(gameList[currentIdx].en);
        msg.lang = 'en-US';
        window.speechSynthesis.speak(msg);
    }

    async function fetchImage(word) {
        const img = document.getElementById('wordImage');
        const ph = document.getElementById('placeholder');
        img.style.display = 'none'; ph.style.display = 'block';
        try {
            const res = await fetch(`https://api.unsplash.com/search/photos?query=${word}&per_page=1&client_id=XDJVghn6USaEIhWdqnBGQ1f8NXr0BRngG8_kI3eRlgw`);
            const data = await res.json();
            if(data.results[0]) {
                img.src = data.results[0].urls.small;
                img.onload = () => { img.style.display = 'block'; ph.style.display = 'none'; };
            }
        } catch (e) {}
    }

    // å…¨åŸŸ Enter ç›£è½ (ç•¶ç„¦é»ä¸åœ¨ input ä¸Šæ™‚ä¹Ÿèƒ½é‹ä½œ)
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && document.getElementById('gamePanel').classList.contains('active')) {
            // é¿å…èˆ‡ input å…§çš„ Enter é‡ç–Šè§¸ç™¼
            if (e.target.tagName !== 'INPUT') {
                handleAction();
            }
        }
    });

    loadGroups();
</script>
</body>
</html>
