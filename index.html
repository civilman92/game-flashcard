<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0;
            --success: #66BB6A;
            --danger: #EF5350;
            --bg: #F5F7FA;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            max-width: 900px;
            width: 100%;
            padding: 20px 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-info {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .score-board {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .score-icon {
            font-size: 22px;
            animation: bounceIn 0.5s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .trophy { color: #f39c12; }
        .skull { color: #e74c3c; }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .panel { display: none; }
        .active { display: block; }

        .image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 12px;
        }
        .image-container {
            width: 100%;
            max-width: 520px;
            height: 260px;
            background: #f5f5f5;
            border-radius: 16px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        .image-placeholder {
            font-size: 50px;
            color: #adb5bd;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04); }
        }
        .image-status-text {
            margin-top: 4px;
            font-size: 12px;
            color: #555;
        }

        .chinese-hint {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
            color: #333;
        }

        .letter-inputs {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 14px 0;
            flex-wrap: wrap;
        }
        .letter-box {
            width: 46px;
            height: 58px;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            outline: none;
            transition: all 0.25s;
            background: white;
        }
        .letter-box:focus {
            border-color: var(--primary);
            background: #e8f0fe;
            box-shadow: 0 0 0 3px rgba(92,107,192,0.25);
        }
        .letter-box.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .letter-box.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .result-message {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 8px 0 4px;
            min-height: 28px;
            padding: 8px 10px;
            border-radius: 14px;
        }
        .result-correct {
            background: #d4edda;
            color: #155724;
        }
        .result-wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 10px 26px;
            border: none;
            border-radius: 22px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s;
            box-shadow: 0 4px 14px rgba(0,0,0,0.15);
            margin: 4px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(92,107,192,0.4);
        }
        .btn-speaker {
            background: #fff176;
            color: #333;
            font-size: 18px;
            box-shadow: 0 4px 14px rgba(255,235,59,0.4);
        }
        .btn-speaker:hover {
            transform: translateY(-2px);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .summary-table th, .summary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .summary-table th {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
            color: white;
            font-weight: 700;
        }
        .status-correct { color: var(--success); font-weight: 700; }
        .status-wrong { color: var(--danger); font-weight: 700; }

        /* ä¿®æ­£ setupPanel æ¨£å¼ */
        #groupSelection label { cursor: pointer; user-select: none; }
        #groupSelection input[type="checkbox"] { transform: scale(1.2); margin-right: 8px; }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .image-container { height: 220px; }
            .chinese-hint { font-size: 26px; }
            .letter-box { width: 40px; height: 52px; font-size: 20px; }
            .score-board { padding: 4px 8px; }
            .score-icon { font-size: 20px; }
            .btn { font-size: 14px; padding: 8px 20px; }
            .result-message { font-size: 18px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 10px; font-size: 24px;">ğŸ“š è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</h2>
        <h3 style="font-size: 18px; margin-bottom: 8px;">é¸æ“‡é¡Œçµ„ä¾†æºï¼š</h3>
        
        <div id="groupSelection" style="min-height: 120px; border: 2px dashed #dee2e6; border-radius: 10px; padding: 10px; margin-bottom: 12px; text-align: left;">
            <p style="text-align:center; color:#555;">è¼‰å…¥å¾Œå°é¡Œçµ„ä¸­...</p>
        </div>
        
        <div id="selectionStatus" style="font-size:14px; color:#5C6BC0; text-align:center; margin-bottom: 8px;"></div>
        <div style="text-align:center;">
            <button class="btn btn-primary" id="startGameBtn" onclick="initGame()" disabled>ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="gamePanel" class="panel">
        <div class="header">
            <div class="progress-info">
                <div id="questionTitle" style="font-size: 20px; margin-bottom: 2px;">ç¬¬ 1 é¡Œ</div>
                <div>é€²åº¦: <span id="progressText">0/20</span></div>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-wrapper">
            <div class="image-container">
                <img id="wordImage" src="" alt="å–®å­—åœ–ç‰‡" style="display:none;">
                <div id="imagePlaceholder" class="image-placeholder" style="display:none;">ğŸ“·</div>
            </div>
            <div id="imageStatusText" class="image-status-text"></div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center; margin-bottom: 4px;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š å†è½ä¸€æ¬¡</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        
        <div class="result-message" id="resultMessage"></div>

        <div style="text-align:center; margin-top:4px;">
            <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">å®Œæˆ</button>
        </div>
    </div>

    <div id="resultPanel" class="panel">
        <h2 style="text-align: center; font-size: 26px; margin-bottom: 10px;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div style="max-height: 360px; overflow-y: auto; margin: 10px 0;">
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>å–®å­—</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:6px;">
            <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    // è¨­ç½® API_BASE ç‚ºæœ¬åœ°ä¼ºæœå™¨åœ°å€
    const API_BASE = 'http://localhost:3000/api';
    const UNSPLASH_ACCESS_KEY = 'XDJVghn6USaEIhWdqnBGQ1f8NXr0BRngG8_kI3eRlgw';

    let allGroups = []; // å„²å­˜å¾å¾Œå°è¼‰å…¥çš„æ‰€æœ‰é¡Œçµ„
    let wordBank = [], gameList = [], currentIdx = 0, results = [], scores = [];
    let imageCache = new Map();
    let answerChecked = false;

    // ===================================================
    // éŠæˆ²è¨­å®šè¼‰å…¥é‚è¼¯ (æ–°å¢/ä¿®æ”¹)
    // ===================================================

    // å¾å¾Œå°è¼‰å…¥é¡Œçµ„ä¸¦å»ºç«‹å¤šé¸æ¡†
    async function loadGroupsForSetup() {
        const panel = document.getElementById('groupSelection');
        const statusDiv = document.getElementById('selectionStatus');
        const startBtn = document.getElementById('startGameBtn');
        panel.innerHTML = '<p style="text-align:center; color:#555;">è¼‰å…¥å¾Œå°é¡Œçµ„ä¸­...</p>';
        startBtn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/groups`);
            if (!res.ok) throw new Error('è®€å–å¤±æ•—ï¼š' + res.status);
            allGroups = await res.json(); 

            if (allGroups.length === 0) {
                panel.innerHTML = '<p style="text-align:center; color:#c00;">å¾Œå°ç›®å‰ç„¡ä»»ä½•é¡Œçµ„ã€‚</p>';
                statusDiv.textContent = 'è«‹å…ˆä½¿ç”¨ç®¡ç†ä»‹é¢æ–°å¢é¡Œçµ„ã€‚';
                return;
            }

            panel.innerHTML = '';
            let totalWords = 0;
            allGroups.forEach((g, index) => {
                const wordCount = g.words?.length || 0;
                totalWords += wordCount;
                const checkboxId = `group-${index}`;
                const div = document.createElement('div');
                div.style.cssText = 'padding: 4px 0;';
                div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" data-index="${index}" onchange="updateStartButton()">
                    <label for="${checkboxId}">
                        ${g.name} (${wordCount} è©)
                    </label>
                `;
                panel.appendChild(div);
            });
            
            updateStartButton(); // åˆå§‹æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
            statusDiv.textContent = `å…± ${allGroups.length} å€‹é¡Œçµ„ï¼Œç¸½è¨ˆ ${totalWords} å€‹å–®å­—ã€‚`;

        } catch (err) {
            console.error('è¼‰å…¥é¡Œçµ„å¤±æ•—:', err);
            panel.innerHTML = '<p style="text-align:center; color:#c00;">ç„¡æ³•é€£ç·šåˆ°å¾Œå°ä¼ºæœå™¨ã€‚</p>';
            statusDiv.textContent = 'è«‹ç¢ºèªå¾Œå° (server.js) å·²å•Ÿå‹•ã€‚';
        }
    }

    // æª¢æŸ¥é¸æ“‡çš„é¡Œçµ„æ•¸é‡ï¼Œä¸¦æ›´æ–°é–‹å§‹æŒ‰éˆ•ç‹€æ…‹
    function updateStartButton() {
        const selectedGroups = document.querySelectorAll('#groupSelection input:checked');
        const startBtn = document.getElementById('startGameBtn');
        const statusDiv = document.getElementById('selectionStatus');
        
        let selectedWordCount = 0;
        selectedGroups.forEach(checkbox => {
            const index = checkbox.dataset.index;
            selectedWordCount += allGroups[index].words?.length || 0;
        });

        const maxQuestions = 20;

        if (selectedGroups.length === 0) {
            startBtn.disabled = true;
            startBtn.textContent = 'è«‹é¸æ“‡è‡³å°‘ä¸€å€‹é¡Œçµ„';
            statusDiv.textContent = '';
        } else if (selectedWordCount < 5) { // è‡³å°‘5å€‹è©æ‰å…è¨±é–‹å§‹
            startBtn.disabled = true;
            startBtn.textContent = `å–®å­—æ•¸é‡ä¸è¶³ (ç›®å‰ ${selectedWordCount} è©)`;
            statusDiv.textContent = 'å»ºè­°é¸æ“‡è¶³å¤ çš„é¡Œçµ„ï¼Œä»¥ç²å¾—å®Œæ•´éŠæˆ²é«”é©—ã€‚';
        } else {
            startBtn.disabled = false;
            // é¡¯ç¤ºå¯¦éš›éŠæˆ²é¡Œæ•¸ (å– wordBank ç¸½æ•¸èˆ‡ 20 çš„æœ€å°å€¼)
            startBtn.textContent = `ğŸš€ é–‹å§‹æŒ‘æˆ° (${Math.min(maxQuestions, selectedWordCount)} é¡Œ)`;
            statusDiv.textContent = `å·²é¸æ“‡ ${selectedGroups.length} å€‹é¡Œçµ„ï¼Œå…± ${selectedWordCount} è©ã€‚`;
        }
    }

    // å•Ÿå‹•éŠæˆ² (ä¿®æ”¹)
    function initGame() {
        const selectedCheckboxes = document.querySelectorAll('#groupSelection input:checked');
        if (selectedCheckboxes.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡Œçµ„ï¼");
            return;
        }

        wordBank = [];
        selectedCheckboxes.forEach(checkbox => {
            const index = checkbox.dataset.index;
            // å°‡é¸å–çš„é¡Œçµ„ä¸­çš„æ‰€æœ‰å–®å­—åŠ å…¥ wordBank
            wordBank.push(...(allGroups[index].words || []));
        });
        
        if (wordBank.length === 0) {
             alert("æ‚¨é¸æ“‡çš„é¡Œçµ„ä¸­æ²’æœ‰ä»»ä½•å–®å­—ï¼Œè«‹æª¢æŸ¥å¾Œå°è³‡æ–™ã€‚");
             return;
        }

        const gameCount = Math.min(20, wordBank.length); 
        
        // éš¨æ©Ÿå¾ wordBank ä¸­é¸å–æœ€å¤š 20 å€‹å–®å­—ä½œç‚ºéŠæˆ²åˆ—è¡¨
        gameList = [...wordBank].sort(() => Math.random() - 0.5).slice(0, gameCount); 
        
        // æª¢æŸ¥å–®å­—æ•¸é‡æ˜¯å¦è¶³å¤ 
        if (gameList.length === 0) {
             alert("å–®å­—æ•¸é‡ä¸è¶³ï¼ŒéŠæˆ²ç„¡æ³•é€²è¡Œã€‚");
             return;
        }

        imageCache.clear();
        scores = [];
        results = [];
        currentIdx = 0;
        answerChecked = false;

        document.getElementById('scoreBoard').innerHTML = '';

        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        // ä¿®æ­£é€²åº¦æ¢åˆå§‹åŒ–
        document.getElementById('progressText').textContent = `0/${gameCount}`; 
        
        loadQuestion();
    }
    
    // ===================================================
    // éŠæˆ²é‹è¡Œé‚è¼¯ (ä¿®æ­£ hardcoded 20)
    // ===================================================
    
    // è¼‰å…¥é¡Œç›® (ä¿®æ­£)
    function loadQuestion() {
        const q = gameList[currentIdx];
        const gameCount = gameList.length; // éŠæˆ²ç¸½é¡Œæ•¸

        document.getElementById('questionTitle').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
        document.getElementById('progressText').textContent = `${currentIdx + 1}/${gameCount}`; // ä¿®æ­£
        document.getElementById('chineseHint').textContent = q.ch;
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('resultMessage').className = 'result-message';
        document.getElementById('actionBtn').textContent = 'å®Œæˆ';

        loadWordImage(q.en);

        const container = document.getElementById('letterInputs');
        container.innerHTML = '';

        let inputCount = 0;
        q.en.split('').forEach((char) => {
            if (char === ' ' || char === '-') {
                const s = document.createElement('span');
                s.textContent = char;
                s.style.cssText = 'width:24px;height:58px;display:flex;align-items:center;justify-content:center;';
                container.appendChild(s);
            } else {
                const input = document.createElement('input');
                input.className = 'letter-box';
                input.maxLength = 1;
                input.dataset.index = inputCount++;
                input.addEventListener('input', handleInput);
                input.addEventListener('keydown', handleLetterKeydown);
                container.appendChild(input);
            }
        });

        document.querySelectorAll('.letter-box').forEach(box => {
            box.disabled = false;
            box.className = 'letter-box';
            box.value = '';
        });

        answerChecked = false;

        // è‡ªå‹•ç™¼éŸ³ + èšç„¦ç¬¬ä¸€æ ¼
        setTimeout(() => {
            pronounceWord(false);
            const firstInput = container.querySelector('input');
            if (firstInput) firstInput.focus();
        }, 400);
    }
    
    // è·³åˆ°ä¸‹ä¸€é¡Œ (ä¿®æ­£)
    function goNext() {
        currentIdx++;
        const gameCount = gameList.length; // éŠæˆ²ç¸½é¡Œæ•¸
        if (currentIdx < gameCount) {
            loadQuestion();
        } else {
            showFinalResults();
        }
    }
    
    // ... (å…¶ä»–å‡½æ•¸ä¸è®Š)
    
    // ===================================================
    // ç¶²é è¼‰å…¥æ™‚åŸ·è¡Œ
    // ===================================================
    document.addEventListener('DOMContentLoaded', loadGroupsForSetup);

    // åŸå§‹ç¢¼ä¸­å…¶ä»–å‡½æ•¸å¦‚ loadWordImage, createFallbackSvg, handleInput, handleLetterKeydown, 
    // handleAction, checkAnswer, updateScoreBoard, pronounceWord, showFinalResults ä¿æŒä¸è®Š
    // ç¢ºä¿å®ƒå€‘éƒ½åœ¨ <script> æ¨™ç±¤å…§
    
    // [ä»¥ä¸‹ç‚ºåŸå§‹ç¢¼ä¸­å…¶ä»–æœªä¿®æ”¹ä½†ä»éœ€è¦çš„å‡½æ•¸]
    // ... (loadWordImage, useFallbackSvg, createFallbackSvg, handleInput, handleLetterKeydown, handleAction, checkAnswer, updateScoreBoard, pronounceWord, goNext, showFinalResults)
    // ç”±æ–¼ç¯‡å¹…é™åˆ¶ï¼Œé€™è£¡ä¸é‡è¤‡è²¼ä¸Šæœªä¿®æ”¹çš„å‡½æ•¸ï¼Œä½†åœ¨å¯¦éš›æª”æ¡ˆä¸­å®ƒå€‘æ‡‰ç•¶å­˜åœ¨ã€‚

    // å…¨åŸŸ Enter è™•ç† (ä¿æŒä¸è®Š)
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('gamePanel').classList.contains('active')) return;
        if (e.key !== 'Enter') return;

        const active = document.activeElement;
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
            return;
        }

        e.preventDefault();
        handleAction();
    });

    async function loadWordImage(word) {
        const img = document.getElementById('wordImage');
        const placeholder = document.getElementById('imagePlaceholder');
        const statusText = document.getElementById('imageStatusText');

        if (imageCache.has(word)) {
            img.src = imageCache.get(word);
            img.style.display = 'block';
            placeholder.style.display = 'none';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
            return;
        }

        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerHTML = 'ğŸ” åœ–ç‰‡è¼‰å…¥ä¸­...';
        statusText.textContent = '';

        try {
            const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(word)}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Unsplash API error: ' + res.status);
            const data = await res.json();
            if (data.results && data.results.length > 0) {
                const photo = data.results[0];
                const imgUrl = photo.urls && (photo.urls.small || photo.urls.regular);
                if (imgUrl) {
                    imageCache.set(word, imgUrl);
                    img.src = imgUrl;
                    img.onload = () => {
                        placeholder.style.display = 'none';
                        img.style.display = 'block';
                        statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
                    };
                    img.onerror = () => {
                        useFallbackSvg(word, img, placeholder, statusText);
                    };
                    return;
                }
            }
            useFallbackSvg(word, img, placeholder, statusText);
        } catch (err) {
            console.error('Unsplash è«‹æ±‚éŒ¯èª¤ï¼š', err);
            useFallbackSvg(word, img, placeholder, statusText);
        }
    }

    function useFallbackSvg(word, img, placeholder, statusText) {
        const svgData = createFallbackSvg(word);
        imageCache.set(word, svgData);
        img.src = svgData;
        img.onload = () => {
            placeholder.style.display = 'none';
            img.style.display = 'block';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šè‡ªå‹•ç”¢ç”Ÿæ–‡å­—åœ–ç¤º';
        };
        img.onerror = () => {
            placeholder.innerHTML = `ğŸ“¸ ${word.toUpperCase()}`;
            statusText.textContent = 'åœ–ç‰‡è¼‰å…¥å¤±æ•—';
        };
    }

    function createFallbackSvg(word) {
        const safeWord = (word || '').toUpperCase();
        const svg = `
            <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1"/>
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1"/>
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#grad)"/>
                <text x="50%" y="45%" font-size="56" fill="white" text-anchor="middle" font-weight="bold">
                    ${safeWord}
                </text>
                <text x="50%" y="62%" font-size="24" fill="rgba(255,255,255,0.85)" text-anchor="middle">
                    Vocabulary Card
                </text>
            </svg>
        `;
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }


    function handleInput(e) {
        const input = e.target;
        let value = input.value.toLowerCase().replace(/[^a-z]/g, '');
        input.value = value ? value.toUpperCase() : '';

        if (input.value) {
            const nextIdx = parseInt(input.dataset.index) + 1;
            const nextInput = document.querySelector(`.letter-box[data-index="${nextIdx}"]`);
            if (nextInput) nextInput.focus();
        }
    }

    function handleLetterKeydown(e) {
        const idx = parseInt(e.target.dataset.index);

        if (e.key === 'ArrowLeft') {
            const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
            if (prev) prev.focus();
        } else if (e.key === 'ArrowRight') {
            const next = document.querySelector(`.letter-box[data-index="${idx + 1}"]`);
            if (next) next.focus();
        } else if (e.key === 'Backspace') {
            if (e.target.value) {
                e.target.value = '';
            } else {
                const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
                if (prev) {
                    prev.focus();
                    prev.value = '';
                }
            }
            e.preventDefault();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            handleAction();
        }
    }

    function handleAction() {
        if (!answerChecked) {
            checkAnswer();
        } else {
            goNext();
        }
    }

    function checkAnswer() {
        if (answerChecked) return;

        const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = '', inputIdx = 0;

        q.en.split('').forEach(char => {
            if (char === ' ' || char === '-') userAns += char;
            else userAns += inputs[inputIdx++].value.toLowerCase();
        });

        const isCorrect = userAns === q.en;
        results.push({ q: q.en, ch: q.ch, user: userAns, status: isCorrect });
        scores.push(isCorrect ? 'ğŸ†' : 'ğŸ’€');
        updateScoreBoard();

        inputs.forEach(box => {
            box.disabled = true;
            const correctChar = q.en[parseInt(box.dataset.index)];
            const userChar = box.value.toLowerCase();
            box.classList.add(userChar === correctChar ? 'correct' : 'wrong');
        });

        const resultMsg = document.getElementById('resultMessage');
        if (isCorrect) {
            resultMsg.textContent = 'ğŸ‰ æ­£ç¢ºï¼æŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”';
            resultMsg.className = 'result-message result-correct';
        } else {
            resultMsg.textContent = `âŒ æ­£ç¢ºç­”æ¡ˆï¼š${q.en.toUpperCase()}ï¼ŒæŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”`;
            resultMsg.className = 'result-message result-wrong';
        }

        document.getElementById('actionBtn').textContent = 'ä¸‹ä¸€é¡Œ';
        answerChecked = true;
    }

    function updateScoreBoard() {
        const board = document.getElementById('scoreBoard');
        board.innerHTML = scores.map(score =>
            `<span class="score-icon
