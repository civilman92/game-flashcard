[cite: 1] <!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0;
[cite: 2] --success: #66BB6A;
            --danger: #EF5350;
            --bg: #F5F7FA;
        }
        * {
            margin: 0;
[cite: 3] padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
[cite: 4] }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
[cite: 5] min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
[cite: 6] }
        .container {
            background: white;
[cite: 7] border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            max-width: 900px;
            width: 100%;
            padding: 20px 24px;
[cite: 8] }

        .header {
            display: flex;
[cite: 9] justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-info {
            font-size: 16px;
[cite: 10] font-weight: 600;
            color: #333;
        }
        .score-board {
            display: flex;
[cite: 11] flex-wrap: wrap;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
[cite: 12] }
        .score-icon {
            font-size: 22px;
[cite: 13] animation: bounceIn 0.5s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .trophy { color: #f39c12;
[cite: 14] }
        .skull { color: #e74c3c;
[cite: 15] }
        @keyframes bounceIn {
            0% { transform: scale(0);
[cite: 16] opacity: 0; }
            50% { transform: scale(1.2);
[cite: 17] }
            100% { transform: scale(1); opacity: 1;
[cite: 18] }
        }

        .panel { display: none;
[cite: 19] }
        .active { display: block;
[cite: 20] }

        .image-wrapper {
            display: flex;
[cite: 21] flex-direction: column;
            align-items: center;
            margin-bottom: 12px;
        }
        .image-container {
            width: 100%;
[cite: 22] max-width: 520px;
            height: 260px;
            background: #f5f5f5;
            border-radius: 16px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
[cite: 23] box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }
        .image-container img {
            max-width: 100%;
[cite: 24] max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        .image-placeholder {
            font-size: 50px;
[cite: 25] color: #adb5bd;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { opacity: 0.7;
[cite: 26] transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04);
[cite: 27] }
        }
        .image-status-text {
            margin-top: 4px;
[cite: 28] font-size: 12px;
            color: #555;
        }

        .chinese-hint {
            font-size: 32px;
[cite: 29] font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
            color: #333;
        }

        .letter-inputs {
            display: flex;
[cite: 30] justify-content: center;
            gap: 6px;
            margin: 14px 0;
            flex-wrap: wrap;
        }
        .letter-box {
            width: 46px;
[cite: 31] height: 58px;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            outline: none;
[cite: 32] transition: all 0.25s;
            background: white;
        }
        .letter-box:focus {
            border-color: var(--primary);
[cite: 33] background: #e8f0fe;
            box-shadow: 0 0 0 3px rgba(92,107,192,0.25);
        }
        .letter-box.correct {
            background: var(--success);
[cite: 34] color: white;
            border-color: var(--success);
        }
        .letter-box.wrong {
            background: var(--danger);
[cite: 35] color: white;
            border-color: var(--danger);
        }

        .result-message {
            text-align: center;
[cite: 36] font-size: 20px;
            font-weight: 700;
            margin: 8px 0 4px;
            min-height: 28px;
            padding: 8px 10px;
            border-radius: 14px;
[cite: 37] }
        .result-correct {
            background: #d4edda;
[cite: 38] color: #155724;
        }
        .result-wrong {
            background: #f8d7da;
[cite: 39] color: #721c24;
        }

        .btn {
            padding: 10px 26px;
[cite: 40] border: none;
            border-radius: 22px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s;
            box-shadow: 0 4px 14px rgba(0,0,0,0.15);
            margin: 4px;
[cite: 41] }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
[cite: 42] color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
[cite: 43] box-shadow: 0 8px 22px rgba(92,107,192,0.4);
        }
        .btn-speaker {
            background: #fff176;
[cite: 44] color: #333;
            font-size: 18px;
            box-shadow: 0 4px 14px rgba(255,235,59,0.4);
        }
        .btn-speaker:hover {
            transform: translateY(-2px);
[cite: 45] }

        .summary-table {
            width: 100%;
[cite: 46] border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
[cite: 47] }
        .summary-table th, .summary-table td {
            padding: 10px;
[cite: 48] border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .summary-table th {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
[cite: 49] color: white;
            font-weight: 700;
        }
        .status-correct { color: var(--success); font-weight: 700;
[cite: 50] }
        .status-wrong { color: var(--danger); font-weight: 700;
[cite: 51] }

        /* æ–°å¢ setupPanel æ¨£å¼ */
        #groupSelection label { cursor: pointer;
[cite: 52] user-select: none; }
        #groupSelection input[type="checkbox"] { transform: scale(1.2); margin-right: 8px;
[cite: 53] }
        .custom-questions-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        .custom-questions-box textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }


        @media (max-width: 768px) {
            .container { padding: 16px;
[cite: 54] }
            .image-container { height: 220px;
[cite: 55] }
            .chinese-hint { font-size: 26px;
[cite: 56] }
            .letter-box { width: 40px; height: 52px; font-size: 20px;
[cite: 57] }
            .score-board { padding: 4px 8px;
[cite: 58] }
            .score-icon { font-size: 20px;
[cite: 59] }
            .btn { font-size: 14px; padding: 8px 20px;
[cite: 60] }
            .result-message { font-size: 18px;
[cite: 61] }
        }
    </style>
</head>
<body>
<div class="container">
    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 10px; font-size: 24px;">ğŸ“š è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</h2>
        <h3 style="font-size: 18px; margin-bottom: 8px;">1. é¸æ“‡å¾Œå°é¡Œçµ„ä¾†æºï¼š</h3>
        
        <div id="groupSelection" style="min-height: 120px; border: 2px dashed #dee2e6; border-radius: 10px; padding: 10px; margin-bottom: 12px; text-align: left;">
            <p style="text-align:center; color:#555;">è¼‰å…¥å¾Œå°é¡Œçµ„ä¸­...</p>
        
[cite: 62] </div>
        
        <h3 style="font-size: 18px; margin-bottom: 8px; margin-top: 15px;">2. æ‰‹å‹•è¼¸å…¥è€ƒé¡Œ (å¯é¸)ï¼š</h3>
        <div class="custom-questions-box">
            <textarea id="customQuestionsInput" placeholder="è«‹è¼¸å…¥è‡ªè¨‚å–®å­—ï¼Œæ ¼å¼ï¼šå–®å­—/ä¸­æ–‡æç¤ºï¼Œæ¯è¡Œä¸€çµ„ã€‚ä¾‹å¦‚ï¼šCAT/è²“&#10;DOG/ç‹—"></textarea>
            <div id="customStatus" style="font-size:12px; color:#555; margin-top: 5px;"></div>
        </div>
        <div id="selectionStatus" style="font-size:14px; color:#5C6BC0; text-align:center; margin: 10px 0 8px;"></div>
        <div style="text-align:center;">
            <button class="btn btn-primary" id="startGameBtn" onclick="initGame()" disabled>ğŸš€ é–‹å§‹æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="gamePanel" class="panel">
        <div class="header">
            <div class="progress-info">
           
[cite: 63]      <div id="questionTitle" style="font-size: 20px; margin-bottom: 2px;">ç¬¬ 1 é¡Œ</div>
                <div>é€²åº¦: <span id="progressText">0/20</span></div>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-wrapper">
            <div class="image-container">
              
[cite: 64]   <img id="wordImage" src="" alt="å–®å­—åœ–ç‰‡" style="display:none;">
                <div id="imagePlaceholder" class="image-placeholder" style="display:none;">ğŸ“·</div>
            </div>
            <div id="imageStatusText" class="image-status-text"></div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center;
[cite: 65] margin-bottom: 4px;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š å†è½ä¸€æ¬¡</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        
        <div class="result-message" id="resultMessage"></div>

        <div style="text-align:center;
 margin-top:4px;">
            <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">å®Œæˆ</button>
        </div>
    </div>

    <div id="resultPanel" class="panel">
        <h2 style="text-align: center;
[cite: 67] font-size: 26px; margin-bottom: 10px;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div style="max-height: 360px; overflow-y: auto;
[cite: 68] margin: 10px 0;">
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>å–®å­—</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:center;
[cite: 69] margin-top:6px;">
            <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    // è¨­ç½® API_BASE ç‚ºæœ¬åœ°ä¼ºæœå™¨åœ°å€
    const API_BASE = 'http://localhost:3000/api';
    const UNSPLASH_ACCESS_KEY = 'XDJVghn6USaEIhWdqnBGQ1f8NXr0BRngG8_kI3eRlgw';

    let allGroups = []; // å„²å­˜å¾å¾Œå°è¼‰å…¥çš„æ‰€æœ‰é¡Œçµ„
    let wordBank = [], gameList = [], currentIdx = 0, results = [], scores = [];
    let imageCache = new Map();
    let answerChecked = false; // [cite: 70, 94]

    // ===================================================
    // éŠæˆ²è¨­å®šè¼‰å…¥é‚è¼¯ (æ–°å¢/ä¿®æ”¹)
    // ===================================================

    // å¾å¾Œå°è¼‰å…¥é¡Œçµ„ä¸¦å»ºç«‹å¤šé¸æ¡†
    async function loadGroupsForSetup() {
        const panel = document.getElementById('groupSelection');
        const startBtn = document.getElementById('startGameBtn');
        panel.innerHTML = '<p style="text-align:center;[cite: 71] color:#555;">è¼‰å…¥å¾Œå°é¡Œçµ„ä¸­...</p>';
        startBtn.disabled = true;

        try {
            // ç™¼é€ GET è«‹æ±‚çµ¦å¾Œå° API å–å¾—é¡Œçµ„åˆ—è¡¨
            const res = await fetch(`${API_BASE}/groups`);
            if (!res.ok) throw new Error('è®€å–å¤±æ•—ï¼š' + res.status);
            allGroups = await res.json(); 

            if (allGroups.length [cite: 72] === 0) {
                panel.innerHTML = '<p style="text-align:center;[cite: 73] color:#c00;">å¾Œå°ç›®å‰ç„¡ä»»ä½•é¡Œçµ„ã€‚</p>';
                return;
            }

            panel.innerHTML = '';
            let totalWords = 0;
            allGroups.forEach((g, index) => {
          
[cite: 74]       const wordCount = g.words?.length || 0;
                totalWords += wordCount;
                const checkboxId = `group-${index}`;
                const div = document.createElement('div');
                div.style.cssText = 'padding: 4px 0;';
             
[cite: 75]    div.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" data-index="${index}" onchange="updateStartButton()">
                    <label for="${checkboxId}">
                        ${g.name} (${wordCount} è©)
                    </label>
    
[cite: 76]             `;
                panel.appendChild(div);
            });
            
            // ç›£è½æ‰‹å‹•è¼¸å…¥æ¡†çš„è®ŠåŒ–ï¼Œå³æ™‚æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('customQuestionsInput').addEventListener('input', updateStartButton);
            
            updateStartButton(); // åˆå§‹æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
            
        } catch (err) {
     
[cite: 77]        console.error('è¼‰å…¥é¡Œçµ„å¤±æ•—:', err);
            panel.innerHTML = '<p style="text-align:center; color:#c00;">ç„¡æ³•é€£ç·šåˆ°å¾Œå°ä¼ºæœå™¨ã€‚</p>';
            document.getElementById('selectionStatus').textContent = 'è«‹ç¢ºèªå¾Œå° (server.js) å·²å•Ÿå‹•ã€‚';
[cite: 78] }
    }

    // è§£ææ‰‹å‹•è¼¸å…¥çš„é¡Œç›®
    function parseCustomQuestions() {
        const text = document.getElementById('customQuestionsInput').value;
        const questions = [];
        // å°‡è¼¸å…¥çš„å–®å­—å¼·åˆ¶è½‰ç‚ºå°å¯«ï¼Œèˆ‡é¡Œåº«ä¿æŒä¸€è‡´
        const lines = text.toLowerCase().split('\n').filter(line => line.trim() !== '');

        for (const line of lines) {
            const parts = line.split('/');
            // æª¢æŸ¥æ ¼å¼ï¼šå¿…é ˆæœ‰å–®å­—å’Œæç¤º
            if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                questions.push({
                    en: parts[0].trim().replace(/\s+/g, ' '), // ç§»é™¤å¤šé¤˜ç©ºç™½
                    ch: parts[1].trim()
                });
            }
        }
        return questions;
    }


    // æª¢æŸ¥é¸æ“‡çš„é¡Œçµ„æ•¸é‡åŠè‡ªè¨‚é¡Œæ•¸ï¼Œä¸¦æ›´æ–°é–‹å§‹æŒ‰éˆ•ç‹€æ…‹ (ä¿®æ”¹)
    function updateStartButton() {
        const selectedGroups = document.querySelectorAll('#groupSelection input:checked');
[cite: 79] const startBtn = document.getElementById('startGameBtn');
        const statusDiv = document.getElementById('selectionStatus');
        const customStatusDiv = document.getElementById('customStatus');
        const maxQuestions = 20;[cite: 81] 
        
        let selectedWordCount = 0;
[cite: 80] selectedGroups.forEach(checkbox => {
            const index = checkbox.dataset.index;
            // ç´¯åŠ å‹¾é¸é¡Œçµ„ä¸­çš„å–®å­—æ•¸é‡
            selectedWordCount += allGroups[index].words?.length || 0;
        });

        // å–å¾—è‡ªè¨‚é¡Œæ•¸
        const customQuestions = parseCustomQuestions();
        const customWordCount = customQuestions.length;

        const totalWords = selectedWordCount + customWordCount;

        if (selectedGroups.length === 0 && customWordCount === 0) {
            startBtn.disabled = true;
[cite: 82] startBtn.textContent = 'è«‹é¸æ“‡æˆ–è¼¸å…¥è‡³å°‘ 5 å€‹å–®å­—';
            statusDiv.textContent = 'æœªé¸æ“‡ä»»ä½•é¡Œçµ„ã€‚';
        } else if (totalWords < 5) { // è‡³å°‘5å€‹è©æ‰å…è¨±é–‹å§‹
            startBtn.disabled = true;
[cite: 83] startBtn.textContent = `å–®å­—æ•¸é‡ä¸è¶³ (ç›®å‰ ${totalWords} è©)`;
            statusDiv.textContent = 'å»ºè­°é¸æ“‡è¶³å¤ çš„é¡Œçµ„ï¼Œä»¥ç²å¾—å®Œæ•´éŠæˆ²é«”é©—ã€‚';
        } else {
            startBtn.disabled = false;
[cite: 84] // é¡¯ç¤ºå¯¦éš›éŠæˆ²é¡Œæ•¸ (å–ç¸½å–®å­—æ•¸èˆ‡ 20 çš„æœ€å°å€¼)
            startBtn.textContent = `ğŸš€ é–‹å§‹æŒ‘æˆ° (${Math.min(maxQuestions, totalWords)} é¡Œ)`;
[cite: 85] statusDiv.textContent = `å·²é¸å¾Œå°é¡Œçµ„ ${selectedGroups.length} å€‹ï¼Œå…± ${selectedWordCount} è©ã€‚`;
        }

        customStatusDiv.textContent = `å·²è¼¸å…¥ ${customWordCount} å€‹è‡ªè¨‚å–®å­—ã€‚`;
    }

    // å•Ÿå‹•éŠæˆ² (ä¿®æ”¹ï¼šåˆä½µå¾Œå°èˆ‡è‡ªè¨‚é¡Œç›®)
    function initGame() {
        const selectedCheckboxes = document.querySelectorAll('#groupSelection input:checked');
[cite: 86] 
        const customQuestions = parseCustomQuestions();
        
        wordBank = [];
        
        // 1. åŠ å…¥é¸å–çš„å¾Œå°é¡Œçµ„å–®å­—
[cite: 88] selectedCheckboxes.forEach(checkbox => {
            const index = checkbox.dataset.index;
            // å°‡é¸å–çš„é¡Œçµ„ä¸­çš„æ‰€æœ‰å–®å­—åŠ å…¥ wordBank
            wordBank.push(...(allGroups[index].words || []));
        });

        // 2. åŠ å…¥æ‰‹å‹•è¼¸å…¥çš„å–®å­—
        wordBank.push(...customQuestions);
        
[cite: 89] if (wordBank.length === 0) {
             alert("æ‚¨æ²’æœ‰é¸æ“‡ä»»ä½•é¡Œçµ„ï¼Œä¹Ÿæ²’æœ‰è¼¸å…¥è‡ªè¨‚å–®å­—ï¼Œè«‹æª¢æŸ¥è³‡æ–™ã€‚");
             return;
[cite: 90] }

        const gameCount = Math.min(20, wordBank.length);
[cite: 91] 
        // 3. éš¨æ©Ÿå¾ wordBank ä¸­é¸å–æœ€å¤š 20 å€‹å–®å­—ä½œç‚ºéŠæˆ²åˆ—è¡¨
        gameList = [...wordBank].sort(() => Math.random() - 0.5).slice(0, gameCount);
[cite: 92] 
        if (gameList.length === 0) {
             alert("å–®å­—æ•¸é‡ä¸è¶³ï¼ŒéŠæˆ²ç„¡æ³•é€²è¡Œã€‚");
             return;
[cite: 93] }

        imageCache.clear();
        scores = [];
        results = [];
        currentIdx = 0;
[cite: 94] answerChecked = false;

        document.getElementById('scoreBoard').innerHTML = '';

        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        document.getElementById('progressText').textContent = `0/${gameCount}`; 
        
        loadQuestion();
[cite: 95] }
    
    // è¼‰å…¥é¡Œç›® (ä¿®æ­£ï¼šç¶­æŒä¸è®Šï¼Œå¼•ç”¨åŸç¨‹å¼ç¢¼)
    function loadQuestion() {
        const q = gameList[currentIdx];
[cite: 96] const gameCount = gameList.length; // éŠæˆ²ç¸½é¡Œæ•¸

        document.getElementById('questionTitle').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
[cite: 97] document.getElementById('progressText').textContent = `${currentIdx + 1}/${gameCount}`;
        document.getElementById('chineseHint').textContent = q.ch;
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('resultMessage').className = 'result-message';
        document.getElementById('actionBtn').textContent = 'å®Œæˆ';

        loadWordImage(q.en);
[cite: 98] const container = document.getElementById('letterInputs');
        container.innerHTML = '';

        let inputCount = 0;
[cite: 99] q.en.split('').forEach((char) => {
            if (char === ' ' || char === '-') {
                const s = document.createElement('span');
                s.textContent = char;
                s.style.cssText = 'width:24px;height:58px;display:flex;align-items:center;justify-content:center;';
                container.appendChild(s);
      
[cite: 100]       } else {
                const input = document.createElement('input');
                input.className = 'letter-box';
                input.maxLength = 1;
                input.dataset.index = inputCount++;
                input.addEventListener('input', handleInput);
  
[cite: 101]               input.addEventListener('keydown', handleLetterKeydown);
                container.appendChild(input);
            }
        });
[cite: 102] document.querySelectorAll('.letter-box').forEach(box => {
            box.disabled = false;
            box.className = 'letter-box';
            box.value = '';
        });
[cite: 103] answerChecked = false;

        // è‡ªå‹•ç™¼éŸ³ + èšç„¦ç¬¬ä¸€æ ¼
        setTimeout(() => {
            pronounceWord(false);
            const firstInput = container.querySelector('input');
            if (firstInput) firstInput.focus();
        }, 400);
[cite: 104] }
    
    // è·³åˆ°ä¸‹ä¸€é¡Œ (ä¿®æ­£ï¼šç¶­æŒä¸è®Šï¼Œå¼•ç”¨åŸç¨‹å¼ç¢¼)
    function goNext() {
        currentIdx++;
[cite: 105] const gameCount = gameList.length; // éŠæˆ²ç¸½é¡Œæ•¸
        if (currentIdx < gameCount) {
            loadQuestion();
[cite: 106] } else {
            showFinalResults();
[cite: 107] }
    }
    
    
    // ===================================================
    // ç¶²é è¼‰å…¥æ™‚åŸ·è¡Œ
    // ===================================================
    document.addEventListener('DOMContentLoaded', loadGroupsForSetup);
[cite: 108] // å…¨åŸŸ Enter è™•ç† (ç¶­æŒä¸è®Š)
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('gamePanel').classList.contains('active')) return;
        if (e.key !== 'Enter') return;

        const active = document.activeElement;
        // å¦‚æœç„¦é»åœ¨è¼¸å…¥æ¡†ï¼ˆä¾‹å¦‚å­—æ¯æ–¹å¡Šï¼‰ï¼Œå‰‡ç”± handleLetterKeydown è™•ç†
        if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) {
            return;
        }
        
        // å¦‚æœ Enter ç™¼ç”Ÿåœ¨è¼¸å…¥æ¡†ä¹‹å¤–ï¼Œå‰‡è§¸ç™¼ handleAction
        e.preventDefault();
        handleAction();
   
[cite: 109]  });

    // åœ–åƒè™•ç†å‡½æ•¸ (ç¶­æŒä¸è®Š)
    async function loadWordImage(word) {
        const img = document.getElementById('wordImage');
[cite: 110] const placeholder = document.getElementById('imagePlaceholder');
        const statusText = document.getElementById('imageStatusText');

        if (imageCache.has(word)) {
            img.src = imageCache.get(word);
[cite: 111] img.style.display = 'block';
            placeholder.style.display = 'none';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
            return;
[cite: 112] }

        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerHTML = 'ğŸ” åœ–ç‰‡è¼‰å…¥ä¸­...';
[cite: 113] statusText.textContent = '';

        try {
            const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(word)}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`;
[cite: 114] const res = await fetch(url);
            if (!res.ok) throw new Error('Unsplash API error: ' + res.status);
            const data = await res.json();
[cite: 115] if (data.results && data.results.length > 0) {
                const photo = data.results[0];
[cite: 116] const imgUrl = photo.urls && (photo.urls.small || photo.urls.regular);
                if (imgUrl) {
                    imageCache.set(word, imgUrl);
[cite: 117] img.src = imgUrl;
                    img.onload = () => {
                        placeholder.style.display = 'none';
[cite: 118] img.style.display = 'block';
                        statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
                    };
                    img.onerror = () => {
                        useFallbackSvg(word, img, placeholder, statusText);
[cite: 119] };
                    return;
                }
            }
            useFallbackSvg(word, img, placeholder, statusText);
[cite: 120] } catch (err) {
            console.error('Unsplash è«‹æ±‚éŒ¯èª¤ï¼š', err);
[cite: 121] useFallbackSvg(word, img, placeholder, statusText);
        }
    }

    function useFallbackSvg(word, img, placeholder, statusText) {
        const svgData = createFallbackSvg(word);
[cite: 122] imageCache.set(word, svgData);
        img.src = svgData;
        img.onload = () => {
            placeholder.style.display = 'none';
[cite: 123] img.style.display = 'block';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šè‡ªå‹•ç”¢ç”Ÿæ–‡å­—åœ–ç¤º';
        };
        img.onerror = () => {
            placeholder.innerHTML = `ğŸ“¸ ${word.toUpperCase()}`;
[cite: 124] statusText.textContent = 'åœ–ç‰‡è¼‰å…¥å¤±æ•—';
        };
    }

    function createFallbackSvg(word) {
        const safeWord = (word || '').toUpperCase();
[cite: 125] const svg = `
            <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1"/>
               
[cite: 126]          <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1"/>
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#grad)"/>
                <text x="50%" y="45%" font-size="56" fill="white" text-anchor="middle" font-weight="bold">
            
[cite: 127]         ${safeWord}
                </text>
                <text x="50%" y="62%" font-size="24" fill="rgba(255,255,255,0.85)" text-anchor="middle">
                    Vocabulary Card
                </text>
            </svg>
      
[cite: 128]   `;
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }


    // å­—æ¯è¼¸å…¥è™•ç†å‡½æ•¸ (ç¶­æŒä¸è®Š)
    function handleInput(e) {
        const input = e.target;
[cite: 129] let value = input.value.toLowerCase().replace(/[^a-z]/g, '');
        input.value = value ? value.toUpperCase() : '';
[cite: 130] if (input.value) {
            const nextIdx = parseInt(input.dataset.index) + 1;
[cite: 131] const nextInput = document.querySelector(`.letter-box[data-index="${nextIdx}"]`);
            if (nextInput) nextInput.focus();
        }
    }

    // éµç›¤è™•ç†å‡½æ•¸ (ç¶­æŒä¸è®Š)
    function handleLetterKeydown(e) {
        const idx = parseInt(e.target.dataset.index);
[cite: 132] if (e.key === 'ArrowLeft') {
            const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
[cite: 133] if (prev) prev.focus();
        } else if (e.key === 'ArrowRight') {
            const next = document.querySelector(`.letter-box[data-index="${idx + 1}"]`);
[cite: 134] if (next) next.focus();
        } else if (e.key === 'Backspace') {
            if (e.target.value) {
                e.target.value = '';
[cite: 135] } else {
                const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
[cite: 136] if (prev) {
                    prev.focus();
[cite: 137] prev.value = '';
                }
            }
            e.preventDefault();
[cite: 138] } else if (e.key === 'Enter') {
            e.preventDefault();
            handleAction();
[cite: 139] }
    }

    // å®Œæˆ / ä¸‹ä¸€é¡Œè™•ç†å‡½æ•¸ (ç¶­æŒä¸è®Šï¼Œæ­¤è™•å·²å¯¦ç¾éœ€æ±‚ 1)
    function handleAction() {
        if (!answerChecked) {
            checkAnswer();
[cite: 140] } else {
            goNext();
[cite: 141] }
    }

    // æª¢æŸ¥ç­”æ¡ˆå‡½æ•¸ (ç¶­æŒä¸è®Š)
    function checkAnswer() {
        if (answerChecked) return;
[cite: 142] const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = '', inputIdx = 0;
[cite: 143] q.en.split('').forEach(char => {
            if (char === ' ' || char === '-') userAns += char;
            else userAns += inputs[inputIdx++].value.toLowerCase();
        });
[cite: 144] const isCorrect = userAns === q.en;
        results.push({ q: q.en, ch: q.ch, user: userAns, status: isCorrect });
[cite: 145] scores.push(isCorrect ? 'ğŸ†' : 'ğŸ’€');
        updateScoreBoard();

        inputs.forEach(box => {
            box.disabled = true;
            const correctChar = q.en[parseInt(box.dataset.index)];
            const userChar = box.value.toLowerCase();
            box.classList.add(userChar === correctChar ? 'correct' : 'wrong');
        });
[cite: 146] const resultMsg = document.getElementById('resultMessage');
        if (isCorrect) {
            resultMsg.textContent = 'ğŸ‰ æ­£ç¢ºï¼æŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”';
[cite: 147] resultMsg.className = 'result-message result-correct';
        } else {
            resultMsg.textContent = `âŒ æ­£ç¢ºç­”æ¡ˆï¼š${q.en.toUpperCase()}ï¼ŒæŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”`;
[cite: 148] resultMsg.className = 'result-message result-wrong';
        }

        document.getElementById('actionBtn').textContent = 'ä¸‹ä¸€é¡Œ';
        answerChecked = true;
[cite: 149] }

    // æ›´æ–°è¨ˆåˆ†æ¿å‡½æ•¸ (ç¶­æŒä¸è®Š)
    function updateScoreBoard() {
        const board = document.getElementById('scoreBoard');
[cite: 150] board.innerHTML = scores.map(score =>
            `<span class="score-icon ${score === 'ğŸ†' ? 'trophy' : 'skull'}">${score}</span>`
        ).join('');
[cite: 151] }

    // ç™¼éŸ³å‡½æ•¸ (ç¶­æŒä¸è®Š)
    function pronounceWord(fromButton = true) {
        const q = gameList[currentIdx];
[cite: 152] if (!q) return;

        const msg = new SpeechSynthesisUtterance(q.en);
        msg.lang = 'en-US';
        msg.rate = 0.8;
        msg.volume = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
[cite: 153] }

    // é¡¯ç¤ºæœ€çµ‚çµæœå‡½æ•¸ (ç¶­æŒä¸è®Š)
    function showFinalResults() {
        document.getElementById('gamePanel').classList.remove('active');
[cite: 154] document.getElementById('resultPanel').classList.add('active');
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        results.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.q;
            row.insertCell(1).textContent = r.q;
            row.insertCell(2).textContent = r.user || '(æœªå¡«å¯«)';
            const sCell = row.insertCell(3);
            sCell.textContent = r.status 
[cite: 155]? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤';
            sCell.className = r.status ? 'status-correct' : 'status-wrong';
        });
[cite: 156] }
</script>
</body>
</html>
