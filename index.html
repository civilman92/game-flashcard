<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0; --success: #66BB6A; --danger: #EF5350; --bg: #F5F7FA;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        body { background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 900px; width: 100%; padding: 30px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .score-board { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; background: #f8f9fa; padding: 10px; border-radius: 12px; }
        .balloon { width: 20px; height: 25px; background: #4FC3F7; border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%; position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .balloon.popped { transform: scale(0); opacity: 0; }
        .balloon.missed { background: #CFD8DC; opacity: 0.5; transform: scale(0.8); }
        .panel { display: none; } .active { display: block; }
        
        /* ğŸš€ å„ªåŒ–åœ–ç‰‡å®¹å™¨ */
        .image-container { 
            width: 100%; height: 350px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            border-radius: 20px; margin-bottom: 20px; display: flex; align-items: center; 
            justify-content: center; overflow: hidden; border: 4px solid #e9ecef;
            position: relative; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }
        .image-container img { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .image-placeholder { font-size: 64px; color: #adb5bd; text-align: center; animation: pulse 2s infinite; }
        .image-status { position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #666; background: rgba(255,255,255,0.9); padding: 2px 8px; border-radius: 10px; }
        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

        .chinese-hint { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #2c3e50; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .letter-inputs { display: flex; justify-content: center; gap: 8px; margin: 25px 0; flex-wrap: wrap; }
        .letter-box { width: 55px; height: 70px; border: 3px solid #dee2e6; border-radius: 12px; text-align: center; font-size: 28px; font-weight: bold; text-transform: uppercase; outline: none; transition: all 0.3s; background: white; }
        .letter-box:focus { border-color: var(--primary); background: #e8f0fe; transform: scale(1.05); box-shadow: 0 0 0 3px rgba(92,107,192,0.2); }
        .letter-box.correct { background: var(--success); color: white; border-color: var(--success); animation: bounce 0.6s; }
        .letter-box.wrong { background: var(--danger); color: white; border-color: var(--danger); animation: shake 0.5s; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .dart { position: absolute; font-size: 35px; pointer-events: none; transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 100; display: none; }
        .btn { padding: 14px 40px; border: none; border-radius: 30px; font-size: 18px; cursor: pointer; font-weight: bold; transition: all 0.3s; margin: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #3f51b5); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(92,107,192,0.4); }
        .btn-speaker { background: linear-gradient(135deg, #fff176, #fdd835); color: #333; font-size: 22px; box-shadow: 0 4px 15px rgba(255,235,59,0.4); }
        .btn-speaker:hover { transform: translateY(-2px); }

        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .summary-table th, .summary-table td { padding: 18px; border-bottom: 1px solid #eee; text-align: left; }
        .summary-table th { background: linear-gradient(135deg, var(--primary), #3f51b5); color: white; }
        .status-correct { color: var(--success); font-weight: bold; }
        .status-wrong { color: var(--danger); font-weight: bold; }
        textarea { width: 100%; height: 220px; padding: 20px; border-radius: 15px; border: 3px solid #dee2e6; margin-bottom: 20px; font-size: 16px; resize: vertical; transition: border-color 0.3s; }
        textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(92,107,192,0.1); }
    </style>
</head>
<body>
<div class="container">
    <div id="dart" class="dart">ğŸ¯</div>

    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 15px; font-size: 28px;">ğŸ“š è‹±æ–‡å–®å­—å¿«é–ƒå¡ (è‡ªå‹•åœ–ç‰‡æœå°‹)</h2>
        <textarea id="wordInput" placeholder="æ ¼å¼ï¼šè‹±æ–‡|ä¸­æ–‡&#10;ä¾‹å¦‚ï¼šapple|è˜‹æœ">apple|è˜‹æœ
banana|é¦™è•‰
computer|é›»è…¦
elephant|å¤§è±¡
flower|èŠ±æœµ
guitar|å‰ä»–
happiness|å¿«æ¨‚
internet|ç¶²è·¯
jacket|å¤¾å…‹
kitchen|å»šæˆ¿
lemon|æª¸æª¬
mountain|å±±è„ˆ
notebook|ç­†è¨˜æœ¬
orange|æ©˜å­
pencil|é‰›ç­†
queen|çš‡å
rabbit|å…”å­
school|å­¸æ ¡
tiger|è€è™
umbrella|é›¨å‚˜</textarea>
        <button class="btn btn-primary" style="display: block; margin: 0 auto; font-size: 20px; padding: 16px 50px;" onclick="initGame()">ğŸš€ é–‹å§‹æŒ‘æˆ° 20 é¡Œ</button>
    </div>

    <div id="gamePanel" class="panel">
        <div class="header">
            <div>
                <h3 id="questionTitle" style="margin: 0; font-size: 24px;">ç¬¬ 1 é¡Œ</h3>
                <p style="color: #777; margin: 5px 0 0 0; font-size: 16px;">é€²åº¦: <span id="progressText">0/20</span></p>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-container" id="imageContainer">
            <img id="wordImage" src="" alt="å–®å­—åœ–ç‰‡" style="display: none;">
            <div id="imagePlaceholder" class="image-placeholder" style="display: none;">ğŸ“·</div>
            <div id="imageStatus" class="image-status"></div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        
        <div style="text-align: center;">
            <button class="btn btn-primary" id="submitBtn" onclick="handleCheck()">âœ… æª¢æŸ¥ç­”æ¡ˆ</button>
            <button class="btn btn-primary" id="nextBtn" style="display:none;" onclick="goNext()">â¡ï¸ ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="resultPanel" class="panel">
        <h2 style="text-align: center; font-size: 32px; margin-bottom: 20px;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div style="max-height: 500px; overflow-y: auto; margin: 20px 0;">
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>å–®å­—</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-primary" style="display: block; margin: 0 auto; font-size: 20px; padding: 16px 50px;" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
</div>

<script>
    const defaultWords = document.getElementById('wordInput').value;
    let wordBank = [], gameList = [], currentIdx = 0, results = [];
    let imageCache = new Map();

    // ğŸš€ è¶…å¼·åœ–ç‰‡è¼‰å…¥å™¨ï¼ˆ5å±¤å‚™æ´ + å¿«å–ï¼‰
    function loadWordImage(word) {
        const img = document.getElementById('wordImage');
        const container = document.getElementById('imageContainer');
        const placeholder = document.getElementById('imagePlaceholder');
        const status = document.getElementById('imageStatus');
        
        // æª¢æŸ¥å¿«å–
        if (imageCache.has(word)) {
            img.src = imageCache.get(word);
            img.style.display = 'block';
            status.textContent = 'ğŸ’¾ å¿«å–';
            placeholder.style.display = 'none';
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerHTML = 'ğŸ” æœå°‹ä¸­...';
        status.textContent = 'æœå°‹ä¸­';

        const sources = [
            // å±¤1: Pexelsï¼ˆé«˜å“è³ªå…è²»ï¼‰
            `https://images.pexels.com/photos/414837/pexels-photo-414837.jpeg?auto=compress&cs=tinysrgb&w=800&h=600&fit=crop&dpr=1&${word}`,
            // å±¤2: Unsplashï¼ˆç¶“å…¸ï¼‰
            `https://source.unsplash.com/800x600/?${word}&random=${Date.now()}`,
            // å±¤3: Pixabay
            `https://cdn.pixabay.com/photo/2016/11/29/05/47/gradient-1867267_1280.jpg?${word}`,
            // å±¤4: Picsumï¼ˆéš¨æ©Ÿå„ªè³ªï¼‰
            `https://picsum.photos/seed/${word}${Date.now()}/800/600`,
            // å±¤5: æ™ºæ…§placeholder
            createSmartPlaceholder(word)
        ];

        let attempt = 0;
        function trySource() {
            if (attempt >= sources.length) return;
            
            status.textContent = `å˜—è©¦ ${attempt + 1}/5`;
            img.src = sources[attempt];
            attempt++;
        }

        img.onload = () => {
            imageCache.set(word, img.src); // å¿«å–æˆåŠŸåœ–ç‰‡
            placeholder.style.display = 'none';
            img.style.display = 'block';
            status.textContent = `âœ… ${sources.indexOf(img.src) + 1}å±¤`;
        };

        img.onerror = () => {
            placeholder.innerHTML = `ğŸ“¸ ${word}`;
            if (attempt < sources.length) {
                setTimeout(trySource, 300);
            } else {
                status.textContent = 'å‚™ç”¨åœ–ç¤º';
            }
        };

        trySource();
    }

    function createSmartPlaceholder(word) {
        return `data:image/svg+xml;base64,${btoa(`
            <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1"/>
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1"/>
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#grad)"/>
                <text x="50%" y="45%" font-size="48" fill="white" text-anchor="middle" font-weight="bold">${word.toUpperCase()}</text>
                <text x="50%" y="60%" font-size="24" fill="rgba(255,255,255,0.8)" text-anchor="middle">Learning Card</text>
                <circle cx="50" cy="50" r="25" fill="white" opacity="0.2"/>
                <circle cx="750" cy="550" r="20" fill="white" opacity="0.2"/>
            </svg>
        ')}`;
    }

    function initGame() {
        const raw = document.getElementById('wordInput').value.trim();
        wordBank = raw.split('\n').map(line => {
            const parts = line.split('|');
            return { en: parts[0]?.trim().toLowerCase(), ch: parts[1]?.trim() };
        }).filter(item => item.en && item.ch);

        if (wordBank.length < 20) { alert("è«‹è‡³å°‘è¼¸å…¥ 20 å€‹å–®å­—ï¼"); return; }

        gameList = [...wordBank].sort(() => Math.random() - 0.5).slice(0, 20);
        imageCache.clear(); // é‡ç½®å¿«å–
        
        const board = document.getElementById('scoreBoard');
        board.innerHTML = '';
        for (let i = 0; i < 20; i++) {
            const b = document.createElement('div');
            b.className = 'balloon'; b.id = `balloon-${i}`;
            board.appendChild(b);
        }

        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        loadQuestion();
    }

    function loadQuestion() {
        const q = gameList[currentIdx];
        document.getElementById('questionTitle').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
        document.getElementById('progressText').textContent = `${currentIdx + 1}/20`;
        document.getElementById('chineseHint').textContent = q.ch;
        
        loadWordImage(q.en);
        setTimeout(pronounceWord, 1000);

        const container = document.getElementById('letterInputs');
        container.innerHTML = '';
        q.en.split('').forEach((char, i) => {
            if (char === ' ' || char === '-') {
                const s = document.createElement('span');
                s.textContent = char; s.style.width = '25px'; s.style.height = '70px';
                container.appendChild(s);
            } else {
                const input = document.createElement('input');
                input.className = 'letter-box'; input.maxLength = 1; input.dataset.index = i;
                input.addEventListener('input', e => {
                    if (input.value) {
                        const next = container.querySelector(`input[data-index="${i + 1}"]`);
                        if (next) next.focus();
                    }
                });
                input.addEventListener('keydown', e => {
                    if ((e.key === 'Backspace' || e.key === 'Delete') && !input.value) {
                        const prev = container.querySelector(`input[data-index="${i - 1}"]`);
                        if (prev) prev.focus();
                        e.preventDefault();
                    }
                });
                container.appendChild(input);
            }
        });
        
        document.querySelectorAll('.letter-box').forEach(b => b.className = 'letter-box');
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        setTimeout(() => container.querySelector('input')?.focus(), 1500);
    }

    function handleCheck() {
        const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = '', inputIdx = 0;
        
        q.en.split('').forEach(char => {
            if (char === ' ' || char === '-') userAns += char;
            else userAns += inputs[inputIdx++].value.toLowerCase();
        });

        const isCorrect = userAns === q.en;
        results.push({ q: q.en, ch: q.ch, user: userAns, status: isCorrect });

        inputs.forEach((box, i) => {
            box.disabled = true;
            box.classList.add(isCorrect ? 'correct' : 'wrong');
        });

        // é£›é¢å‹•ç•«
        const dart = document.getElementById('dart');
        const target = document.getElementById(`balloon-${currentIdx}`);
        const rect = target.getBoundingClientRect();
        
        dart.style.display = 'block'; dart.style.left = '50%'; dart.style.top = '10%'; dart.style.opacity = '1';
        setTimeout(() => {
            if (isCorrect) {
                dart.style.left = `${rect.left + 10}px`; dart.style.top = `${rect.top + 5}px`;
                setTimeout(() => { target.classList.add('popped'); dart.style.opacity = '0'; }, 500);
            } else {
                dart.style.left = `${rect.left - 30}px`; dart.style.top = `${rect.top - 20}px`;
                setTimeout(() => { target.classList.add('missed'); dart.style.opacity = '0'; }, 500);
            }
        }, 100);

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
    }

    function pronounceWord() {
        const q = gameList[currentIdx];
        const msg = new SpeechSynthesisUtterance(q.en);
        msg.lang = 'en-US'; msg.rate = 0.7; msg.volume = 0.9;
        speechSynthesis.speak(msg);
    }

    function goNext() { currentIdx++; if (currentIdx < 20) loadQuestion(); else showFinalResults(); }

    function showFinalResults() {
        document.getElementById('gamePanel').classList.remove('active');
        document.getElementById('resultPanel').classList.add('active');
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        results.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.q;
            row.insertCell(1).textContent = r.q;
            row.insertCell(2).textContent = r.user || '(æœªå¡«å¯«)';
            const sCell = row.insertCell(3);
            sCell.textContent = r.status ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤';
            sCell.className = r.status ? 'status-correct' : 'status-wrong';
        });
    }
</script>
</body>
</html>
