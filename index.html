<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Microsoft JhengHei', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}
.container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    max-width: 900px;
    width: 100%;
    padding: 30px;
}
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.progress-container {
    width: 200px;
}
.progress-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    width: 0%;
    transition: width 0.3s ease;
}
.title {
    font-size: 26px;
    font-weight: bold;
    color: #333;
    text-align: center;
}
.setup-panel {
    padding: 18px;
    background: #f8f9fa;
    border-radius: 15px;
    margin-bottom: 20px;
}
.setup-section-title {
    font-size: 18px;
    margin-bottom: 6px;
}
.word-setup {
    width: 100%;
    height: 140px;
    resize: vertical;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 10px;
}
.small-note {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
}
.groups-list {
    max-height: 160px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 6px 8px;
    background: #fff;
}
.group-item {
    display: flex;
    align-items: center;
    padding: 4px 0;
    font-size: 14px;
}
.group-item label {
    margin-left: 4px;
}
.num-input {
    width: 80px;
    padding: 4px 6px;
    border-radius: 8px;
    border: 2px solid #dee2e6;
    text-align: right;
    font-size: 14px;
}
.word-display {
    text-align: center;
    margin-bottom: 20px;
    padding: 20px;
    background: #f0f8ff;
    border-radius: 15px;
    min-height: 180px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
.word-icon {
    font-size: 70px;
    margin-bottom: 14px;
    color: #667eea;
}
.chinese-meaning {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 12px;
}
.pronounce-btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-size: 15px;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.3s;
}
.pronounce-btn:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}
.letter-inputs {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin: 20px 0;
    flex-wrap: wrap;
}
.letter-box {
    width: 45px;
    height: 55px;
    border: 3px solid #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    text-transform: uppercase;
    background: white;
    transition: all 0.3s;
}
.letter-box.correct {
    background: #4CAF50;
    color: white;
    border-color: #4CAF50;
}
.letter-box.incorrect {
    background: #f44336;
    color: white;
    border-color: #f44336;
    animation: shake 0.5s;
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
.control-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
}
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 22px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
}
.btn-primary {
    background: #667eea;
    color: white;
}
.btn-primary:hover {
    background: #5a67d8;
    transform: translateY(-2px);
}
.btn-secondary {
    background: #6c757d;
    color: white;
}
.btn-secondary:hover {
    background: #545b62;
    transform: translateY(-2px);
}
.result-message {
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    margin: 15px 0;
    min-height: 26px;
}
.correct-text { color: #4CAF50; }
.wrong-text { color: #f44336; }
.hidden { display: none; }
@media (max-width: 600px) {
    .letter-box {
        width: 35px;
        height: 45px;
        font-size: 16px;
    }
    .container {
        padding: 20px;
    }
}
</style>
</head>

<body>
<div class="container">
    <div class="header">
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; font-size: 14px; margin-top: 5px;">
                <span id="progressText">0/0</span>
            </div>
        </div>
        <div class="title">è‹±æ–‡å–®å­—å¿«é–ƒå¡</div>
        <div style="width: 200px;"></div>
    </div>

    <!-- è¨­å®šé¢æ¿ -->
    <div id="setupPanel" class="setup-panel">
        <h3 class="setup-section-title">ğŸ“š é¡Œåº«è¨­å®š</h3>

        <div style="margin-bottom:12px;">
            <div class="setup-section-title" style="font-size:16px;">ä¾†æºä¸€ï¼šè‡ªè¨‚å–®å­—é¡Œåº«</div>
            <p class="small-note">æ ¼å¼ï¼šè‹±æ–‡|ä¸­æ–‡|åœ–ç¤ºemojiï¼Œä¸€è¡Œä¸€çµ„ã€‚ä¾‹å¦‚ï¼šapple|è˜‹æœ|ğŸ</p>
            <textarea id="wordSetup" class="word-setup" placeholder="apple|è˜‹æœ|ğŸ"></textarea>
        </div>

        <div style="margin-bottom:12px;">
            <div class="setup-section-title" style="font-size:16px;">ä¾†æºäºŒï¼šå¾Œå°é¡Œçµ„ï¼ˆå¯å¤šé¸ï¼‰</div>
            <p class="small-note">é€™äº›é¡Œçµ„ä¾†è‡ªå¾Œå°ç®¡ç†é ï¼ˆadmin.htmlï¼‰èˆ‡ MongoDBã€‚</p>
            <div id="groupsList" class="groups-list">
                <p class="small-note">è®€å–é¡Œçµ„ä¸­...</p>
            </div>
            <p class="small-note" style="margin-top:6px;">
                è‹¥è¦æ–°å¢ / ç·¨è¼¯é¡Œçµ„ï¼Œè«‹å‰å¾€å¾Œå°ï¼š
                <a href="admin.html" target="_blank">é–‹å•Ÿç®¡ç†åŠç·¨è¼¯é¡Œçµ„é é¢</a>
            </p>
        </div>

        <div style="margin-bottom:12px;">
            <div class="setup-section-title" style="font-size:16px;">é¡Œæ•¸è¨­å®š</div>
            <label for="questionCount" class="small-note">é¡Œæ•¸ï¼ˆ1ï½30ï¼‰ï¼š</label><br>
            <input id="questionCount" type="number" class="num-input" min="1" max="30" value="20">
        </div>

        <button class="btn btn-primary" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²é¢æ¿ -->
    <div id="gamePanel" class="hidden">
        <div class="word-display">
            <div class="word-icon" id="wordIcon">ğŸ¯</div>
            <div class="chinese-meaning" id="chineseMeaning">æº–å‚™é–‹å§‹...</div>
            <button class="pronounce-btn" onclick="pronounceWord()" id="pronounceBtn">ğŸ”Š è½ç™¼éŸ³</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>

        <div class="result-message" id="resultMessage"></div>

        <div class="control-buttons">
            <button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()">å®Œæˆ</button>
            <button class="btn btn-secondary" onclick="showAnswer()">é¡¯ç¤ºç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<script>
// å¾Œå° API åŸºåº•ç¶²å€ï¼šè«‹æ”¹æˆä½ çš„å¾Œç«¯ç¶²å€
// ä¾‹å¦‚ï¼šconst API_BASE = 'http://localhost:3000/api';
const API_BASE = 'http://localhost:3000/api';

// å¾å¾Œç«¯å–å¾—çš„é¡Œçµ„é›†åˆï¼š{ groupName: [ {english, chinese, icon}, ... ], ... }
let predefinedGroups = {};

let wordBank = [];         // åˆä½µå¾Œçš„ç¸½é¡Œåº«
let currentQuestions = []; // æœ¬æ¬¡æŠ½å‡ºçš„é¡Œç›®
let currentQuestionIndex = 0;
let currentWord = '';
let letterInputs = [];
let answerChecked = false;

// é é¢è¼‰å…¥æ™‚ï¼Œå…ˆå¾å¾Œç«¯è®€å–é¡Œçµ„
document.addEventListener('DOMContentLoaded', () => {
    loadGroupsFromServer();
});

// å¾å¾Œç«¯è¼‰å…¥é¡Œçµ„åˆ—è¡¨
async function loadGroupsFromServer() {
    const list = document.getElementById('groupsList');
    list.innerHTML = '<p class="small-note">è®€å–é¡Œçµ„ä¸­...</p>';
    try {
        const res = await fetch(`${API_BASE}/groups`, { method: 'GET' });
        if (!res.ok) throw new Error('è®€å–é¡Œçµ„å¤±æ•—ï¼š' + res.status);
        const groups = await res.json(); // é æœŸæ ¼å¼ï¼š[{ name, words:[{english,chinese,icon},...] }, ...]
        predefinedGroups = {};
        groups.forEach(g => {
            predefinedGroups[g.name] = (g.words || []).map(w => ({
                english: (w.english || '').toLowerCase(),
                chinese: w.chinese || '',
                icon: w.icon || 'â“'
            }));
        });
        renderGroupsList();
    } catch (err) {
        console.error('è¼‰å…¥é¡Œçµ„å¤±æ•—ï¼š', err);
        list.innerHTML = '<p class="small-note" style="color:#c00;">ç„¡æ³•å¾å¾Œå°è®€å–é¡Œçµ„ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
    }
}

// åœ¨è¨­å®šé¢æ¿é¡¯ç¤ºé¡Œçµ„æ¸…å–®ï¼ˆå¤šé¸ï¼‰
function renderGroupsList() {
    const list = document.getElementById('groupsList');
    list.innerHTML = '';
    const names = Object.keys(predefinedGroups);
    if (names.length === 0) {
        list.innerHTML = '<p class="small-note">ç›®å‰æ²’æœ‰ä»»ä½•é¡Œçµ„ï¼Œè«‹å…ˆåˆ°å¾Œå°ç®¡ç†é æ–°å¢ã€‚</p>';
        return;
    }
    names.forEach(name => {
        const id = 'group-' + name.replace(/\s+/g, '-');
        const div = document.createElement('div');
        div.className = 'group-item';
        div.innerHTML = `
            <input type="checkbox" id="${id}" data-group="${encodeURIComponent(name)}">
            <label for="${id}">${name}ï¼ˆ${predefinedGroups[name].length} é¡Œï¼‰</label>
        `;
        list.appendChild(div);
    });
}

// è§£æè‡ªè¨‚è¼¸å…¥çš„é¡Œåº«
function parseWordSetup(text) {
    if (!text.trim()) return [];
    const lines = text.trim().split('\n');
    return lines.map(line => {
        const parts = line.split('|').map(s => s.trim());
        const english = parts[0] || '';
        const chinese = parts[1] || '';
        const icon = parts[2] || 'â“';
        if (english && chinese) {
            return {
                english: english.toLowerCase(),
                chinese,
                icon
            };
        }
        return null;
    }).filter(Boolean);
}

// é–‹å§‹éŠæˆ²ï¼šåˆä½µè‡ªè¨‚ + é¡Œçµ„ï¼Œéš¨æ©ŸæŠ½é¡Œ
function startGame() {
    const setupText = document.getElementById('wordSetup').value;
    const customWords = parseWordSetup(setupText);

    // å¾å‹¾é¸çš„é¡Œçµ„æ”¶é›†å–®å­—
    const checkedGroups = Array.from(document.querySelectorAll('#groupsList input[type="checkbox"]:checked'));
    let groupWords = [];
    checkedGroups.forEach(cb => {
        const name = decodeURIComponent(cb.dataset.group);
        const arr = predefinedGroups[name] || [];
        groupWords = groupWords.concat(arr);
    });

    wordBank = [];
    customWords.forEach(w => wordBank.push(w));
    groupWords.forEach(w => wordBank.push(w));

    if (wordBank.length === 0) {
        alert('è«‹è‡³å°‘åœ¨ã€Œè‡ªè¨‚å–®å­—ã€æˆ–ã€Œå¾Œå°é¡Œçµ„ã€ä¸­æä¾›ä¸€å€‹ä»¥ä¸Šçš„å–®å­—ã€‚');
        return;
    }

    const countInput = document.getElementById('questionCount');
    let desiredCount = parseInt(countInput.value, 10) || 1;
    if (desiredCount < 1) desiredCount = 1;
    if (desiredCount > 30) desiredCount = 30;
    const maxCount = wordBank.length;
    const finalCount = Math.min(desiredCount, maxCount);
    countInput.value = finalCount;

    // éš¨æ©ŸæŠ½é¡Œ
    currentQuestions = shuffleArray(wordBank).slice(0, finalCount);
    currentQuestionIndex = 0;
    answerChecked = false;

    document.getElementById('setupPanel').classList.add('hidden');
    document.getElementById('gamePanel').classList.remove('hidden');

    loadQuestion();
    updateProgress();
}

// é™£åˆ—æ´—ç‰Œ
function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

// è¼‰å…¥ä¸€é¡Œ
function loadQuestion() {
    const q = currentQuestions[currentQuestionIndex];
    currentWord = q.english;

    document.getElementById('wordIcon').textContent = q.icon;
    document.getElementById('chineseMeaning').textContent = q.chinese;
    document.getElementById('resultMessage').textContent = '';
    document.getElementById('resultMessage').className = 'result-message';
    document.getElementById('checkBtn').textContent = 'å®Œæˆ';
    answerChecked = false;

    createLetterInputs();
    clearInputs();
    updateProgress();
}

// å»ºç«‹å­—æ¯è¼¸å…¥æ ¼
function createLetterInputs() {
    const container = document.getElementById('letterInputs');
    container.innerHTML = '';
    letterInputs = [];
    for (let i = 0; i < currentWord.length; i++) {
        const box = document.createElement('div');
        box.className = 'letter-box';
        box.dataset.index = i;
        box.contentEditable = true;
        box.addEventListener('input', handleInput);
        box.addEventListener('keydown', handleKeydown);
        container.appendChild(box);
        letterInputs.push(box);
    }
}

// è™•ç†è¼¸å…¥ï¼ˆåªå…è¨± aâ€“zï¼Œä¸¦è‡ªå‹•è·³ä¸‹ä¸€æ ¼ï¼‰
function handleInput(e) {
    const box = e.target;
    let value = box.textContent.toLowerCase().trim();
    if (value.length > 1) value = value[0];
    if (!/^[a-z]$/.test(value)) {
        box.textContent = '';
        return;
    }
    box.textContent = value.toUpperCase();
    const index = parseInt(box.dataset.index, 10);
    if (index < currentWord.length - 1) {
        letterInputs[index + 1].focus();
    }
}

// éµç›¤è¡Œç‚ºï¼šBackspace å·¦ç§»åˆªé™¤ã€Enter å®Œæˆ/ä¸‹ä¸€é¡Œ
function handleKeydown(e) {
    const index = parseInt(e.target.dataset.index, 10);
    if (e.key === 'Backspace' && e.target.textContent === '') {
        if (index > 0) {
            letterInputs[index - 1].focus();
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        handleAction();
    }
}

// å®Œæˆ / ä¸‹ä¸€é¡Œ çš„æ•´é«”å…¥å£ï¼ˆEnter æˆ–æŒ‰éˆ•éƒ½ç”¨é€™å€‹ï¼‰
function handleAction() {
    if (!answerChecked) {
        checkAnswer();
    } else {
        nextQuestion();
    }
}

// æª¢æŸ¥ç­”æ¡ˆï¼ˆç¬¬ä¸€æ¬¡ Enter / å®Œæˆï¼‰
function checkAnswer() {
    if (answerChecked) return;

    let correct = true;
    let userAnswer = '';
    letterInputs.forEach((box, i) => {
        const userChar = box.textContent.toLowerCase();
        const correctChar = currentWord[i];
        if (userChar === correctChar) {
            box.classList.add('correct');
        } else {
            box.classList.add('incorrect');
            correct = false;
        }
        userAnswer += userChar;
    });

    const resultEl = document.getElementById('resultMessage');
    if (correct) {
        resultEl.textContent = 'âœ… æ­£ç¢ºï¼å†æŒ‰ä¸€æ¬¡ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”';
        resultEl.className = 'result-message correct-text';
    } else {
        resultEl.textContent = `âŒ ä¸å°ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${currentWord.toUpperCase()}ï¼Œå†æŒ‰ä¸€æ¬¡ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”`;
        resultEl.className = 'result-message wrong-text';
    }

    answerChecked = true;
    document.getElementById('checkBtn').textContent = 'ä¸‹ä¸€é¡Œ';
}

// é¡¯ç¤ºç­”æ¡ˆï¼ˆä¸å½±éŸ¿åˆ‡é¡Œé‚è¼¯ï¼‰
function showAnswer() {
    letterInputs.forEach((box, i) => {
        box.textContent = currentWord[i].toUpperCase();
        box.classList.add('correct');
    });
    answerChecked = true;
    document.getElementById('checkBtn').textContent = 'ä¸‹ä¸€é¡Œ';
    document.getElementById('resultMessage').textContent = `âœ… æ­£ç¢ºç­”æ¡ˆï¼š${currentWord.toUpperCase()}ï¼Œå†æŒ‰ä¸€æ¬¡ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”`;
    document.getElementById('resultMessage').className = 'result-message correct-text';
}

// ä¸‹ä¸€é¡Œï¼ˆç¬¬äºŒæ¬¡ Enter / å†æŒ‰æŒ‰éˆ•ï¼‰
function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex >= currentQuestions.length) {
        alert('ğŸ‰ æ­å–œå®Œæˆå…¨éƒ¨é¡Œç›®ï¼');
        location.reload();
        return;
    }
    loadQuestion();
}

// æœ—è®€å–®å­—
function pronounceWord() {
    if (!currentWord) return;
    const utterance = new SpeechSynthesisUtterance(currentWord);
    utterance.lang = 'en-US';
    utterance.rate = 0.8;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
}

// æ¸…ç©ºè¼¸å…¥
function clearInputs() {
    letterInputs.forEach(box => {
        box.textContent = '';
        box.className = 'letter-box';
    });
    if (letterInputs[0]) letterInputs[0].focus();
}

// æ›´æ–°é€²åº¦æ¢
function updateProgress() {
    const total = currentQuestions.length || 1;
    const progress = ((currentQuestionIndex + 1) / total) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressText').textContent = `${currentQuestionIndex + 1}/${total}`;
}

// è®“ Enter åœ¨æ•´å€‹éŠæˆ²æ™‚ä¹Ÿèƒ½è§¸ç™¼ handleActionï¼ˆé contentEditable æ™‚ï¼‰
document.addEventListener('keydown', function(e) {
    if (document.getElementById('gamePanel').classList.contains('hidden')) return;
    if (e.key !== 'Enter') return;
    const active = document.activeElement;
    // contentEditable çš„æ ¼å­å·²ç¶“åœ¨ handleKeydown è™•ç† Enter
    if (active && active.isContentEditable) return;
    e.preventDefault();
    handleAction();
});
</script>
</body>
</html>
