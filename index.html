<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</title>
    <style>
        :root {
            --primary: #5C6BC0;
            --success: #66BB6A;
            --danger: #EF5350;
            --bg: #F5F7FA;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
            max-width: 900px;
            width: 100%;
            padding: 20px 24px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .progress-info {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .score-board {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .score-icon {
            font-size: 22px;
            animation: bounceIn 0.5s cubic-bezier(0.68,-0.55,0.265,1.55);
        }
        .trophy { color: #f39c12; }
        .skull { color: #e74c3c; }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .panel { display: none; }
        .active { display: block; }

        .image-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 12px;
        }
        .image-container {
            width: 100%;
            max-width: 520px;
            height: 260px;
            background: #f5f5f5;
            border-radius: 16px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }
        .image-placeholder {
            font-size: 50px;
            color: #adb5bd;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.04); }
        }
        .image-status-text {
            margin-top: 4px;
            font-size: 12px;
            color: #555;
        }

        .chinese-hint {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
            color: #333;
        }

        .letter-inputs {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin: 14px 0;
            flex-wrap: wrap;
        }
        .letter-box {
            width: 46px;
            height: 58px;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            outline: none;
            transition: all 0.25s;
            background: white;
        }
        .letter-box:focus {
            border-color: var(--primary);
            background: #e8f0fe;
            box-shadow: 0 0 0 3px rgba(92,107,192,0.25);
        }
        .letter-box.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .letter-box.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .result-message {
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin: 8px 0 4px;
            min-height: 28px;
            padding: 8px 10px;
            border-radius: 14px;
        }
        .result-correct {
            background: #d4edda;
            color: #155724;
        }
        .result-wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .btn {
            padding: 10px 26px;
            border: none;
            border-radius: 22px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s;
            box-shadow: 0 4px 14px rgba(0,0,0,0.15);
            margin: 4px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(92,107,192,0.4);
        }
        .btn-speaker {
            background: #fff176;
            color: #333;
            font-size: 18px;
            box-shadow: 0 4px 14px rgba(255,235,59,0.4);
        }
        .btn-speaker:hover {
            transform: translateY(-2px);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            background: white;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .summary-table th, .summary-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .summary-table th {
            background: linear-gradient(135deg, var(--primary), #3f51b5);
            color: white;
            font-weight: 700;
        }
        .status-correct { color: var(--success); font-weight: 700; }
        .status-wrong { color: var(--danger); font-weight: 700; }

        textarea {
            width: 100%;
            height: 200px;
            padding: 14px;
            border-radius: 14px;
            border: 3px solid #dee2e6;
            margin-bottom: 12px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }
        textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(92,107,192,0.18);
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .image-container { height: 220px; }
            .chinese-hint { font-size: 26px; }
            .letter-box { width: 40px; height: 52px; font-size: 20px; }
            .score-board { padding: 4px 8px; }
            .score-icon { font-size: 20px; }
            .btn { font-size: 14px; padding: 8px 20px; }
            .result-message { font-size: 18px; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- é¡Œåº«è¨­å®š -->
    <div id="setupPanel" class="panel active">
        <h2 style="text-align: center; margin-bottom: 10px; font-size: 24px;">ğŸ“š è‹±æ–‡å–®å­—å¿«é–ƒå¡éŠæˆ²</h2>
        <textarea id="wordInput">apple|è˜‹æœ
banana|é¦™è•‰
computer|é›»è…¦
elephant|å¤§è±¡
flower|èŠ±æœµ
guitar|å‰ä»–
happiness|å¿«æ¨‚
internet|ç¶²è·¯
jacket|å¤¾å…‹
kitchen|å»šæˆ¿
lemon|æª¸æª¬
mountain|å±±è„ˆ
notebook|ç­†è¨˜æœ¬
orange|æ©˜å­
pencil|é‰›ç­†
queen|çš‡å
rabbit|å…”å­
school|å­¸æ ¡
tiger|è€è™
umbrella|é›¨å‚˜</textarea>
        <div style="text-align:center;">
            <button class="btn btn-primary" onclick="initGame()">ğŸš€ é–‹å§‹æŒ‘æˆ° 20 é¡Œ</button>
        </div>
    </div>

    <!-- éŠæˆ²é¢æ¿ -->
    <div id="gamePanel" class="panel">
        <div class="header">
            <div class="progress-info">
                <div id="questionTitle" style="font-size: 20px; margin-bottom: 2px;">ç¬¬ 1 é¡Œ</div>
                <div>é€²åº¦: <span id="progressText">0/20</span></div>
            </div>
            <div class="score-board" id="scoreBoard"></div>
        </div>

        <div class="image-wrapper">
            <div class="image-container">
                <img id="wordImage" src="" alt="å–®å­—åœ–ç‰‡" style="display:none;">
                <div id="imagePlaceholder" class="image-placeholder" style="display:none;">ğŸ“·</div>
            </div>
            <div id="imageStatusText" class="image-status-text"></div>
        </div>
        
        <div class="chinese-hint" id="chineseHint">è¼‰å…¥ä¸­...</div>
        
        <div style="text-align: center; margin-bottom: 4px;">
            <button class="btn btn-speaker" onclick="pronounceWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>

        <div class="letter-inputs" id="letterInputs"></div>
        
        <div class="result-message" id="resultMessage"></div>

        <div style="text-align:center; margin-top:4px;">
            <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">å®Œæˆ</button>
        </div>
    </div>

    <!-- çµæœé¢æ¿ -->
    <div id="resultPanel" class="panel">
        <h2 style="text-align: center; font-size: 26px; margin-bottom: 10px;">ğŸ† æŒ‘æˆ°å®Œæˆï¼</h2>
        <div style="max-height: 360px; overflow-y: auto; margin: 10px 0;">
            <table class="summary-table" id="summaryTable">
                <thead><tr><th>å–®å­—</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ‚¨çš„å›ç­”</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align:center; margin-top:6px;">
            <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
</div>

<script>
    const UNSPLASH_ACCESS_KEY = 'XDJVghn6USaEIhWdqnBGQ1f8NXr0BRngG8_kI3eRlgw';

    let wordBank = [], gameList = [], currentIdx = 0, results = [], scores = [];
    let imageCache = new Map();
    let answerChecked = false;

    // Enterï¼šåœ¨éŠæˆ²é¢æ¿æ™‚ï¼ŒæŒ‰ Enter ç­‰åŒæŒ‰ã€Œå®Œæˆ / ä¸‹ä¸€é¡Œã€æŒ‰éˆ•
    document.addEventListener('keydown', function(e) {
        if (!document.getElementById('gamePanel').classList.contains('active')) return;
        if (e.key !== 'Enter') return;
        // ä¸é˜»æ“‹å­—æ¯è¼¸å…¥ï¼Œä½†é€™è£¡æ˜¯å…¨åŸŸ keydownï¼Œåªåœ¨é textarea æ™‚é€²è¡Œè™•ç†
        const active = document.activeElement;
        if (active && (active.tagName === 'TEXTAREA')) return;
        e.preventDefault();
        handleAction();
    });

    async function loadWordImage(word) {
        const img = document.getElementById('wordImage');
        const placeholder = document.getElementById('imagePlaceholder');
        const statusText = document.getElementById('imageStatusText');

        if (imageCache.has(word)) {
            img.src = imageCache.get(word);
            img.style.display = 'block';
            placeholder.style.display = 'none';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
            return;
        }

        img.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerHTML = 'ğŸ” åœ–ç‰‡è¼‰å…¥ä¸­...';
        statusText.textContent = '';

        try {
            const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(word)}&per_page=1&orientation=landscape&client_id=${UNSPLASH_ACCESS_KEY}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Unsplash API error: ' + res.status);
            const data = await res.json();
            if (data.results && data.results.length > 0) {
                const photo = data.results[0];
                const imgUrl = photo.urls && (photo.urls.small || photo.urls.regular);
                if (imgUrl) {
                    imageCache.set(word, imgUrl);
                    img.src = imgUrl;
                    img.onload = () => {
                        placeholder.style.display = 'none';
                        img.style.display = 'block';
                        statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šUnsplash';
                    };
                    img.onerror = () => {
                        useFallbackSvg(word, img, placeholder, statusText);
                    };
                    return;
                }
            }
            useFallbackSvg(word, img, placeholder, statusText);
        } catch (err) {
            console.error('Unsplash è«‹æ±‚éŒ¯èª¤ï¼š', err);
            useFallbackSvg(word, img, placeholder, statusText);
        }
    }

    function useFallbackSvg(word, img, placeholder, statusText) {
        const svgData = createFallbackSvg(word);
        imageCache.set(word, svgData);
        img.src = svgData;
        img.onload = () => {
            placeholder.style.display = 'none';
            img.style.display = 'block';
            statusText.textContent = 'åœ–ç‰‡ä¾†æºï¼šè‡ªå‹•ç”¢ç”Ÿæ–‡å­—åœ–ç¤º';
        };
        img.onerror = () => {
            placeholder.innerHTML = `ğŸ“¸ ${word.toUpperCase()}`;
            statusText.textContent = 'åœ–ç‰‡è¼‰å…¥å¤±æ•—';
        };
    }

    function createFallbackSvg(word) {
        const safeWord = (word || '').toUpperCase();
        const svg = `
            <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1"/>
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1"/>
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#grad)"/>
                <text x="50%" y="45%" font-size="56" fill="white" text-anchor="middle" font-weight="bold">
                    ${safeWord}
                </text>
                <text x="50%" y="62%" font-size="24" fill="rgba(255,255,255,0.85)" text-anchor="middle">
                    Vocabulary Card
                </text>
            </svg>
        `;
        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    function initGame() {
        const raw = document.getElementById('wordInput').value.trim();
        wordBank = raw.split('\n').map(line => {
            const parts = line.split('|');
            return { en: parts[0]?.trim().toLowerCase(), ch: parts[1]?.trim() };
        }).filter(item => item.en && item.ch);

        if (wordBank.length < 20) {
            alert("è«‹è‡³å°‘è¼¸å…¥ 20 å€‹å–®å­—ï¼ç›®å‰åªæœ‰ " + wordBank.length + " å€‹");
            return;
        }

        gameList = [...wordBank].sort(() => Math.random() - 0.5).slice(0, 20);
        imageCache.clear();
        scores = [];
        results = [];
        currentIdx = 0;
        answerChecked = false;

        document.getElementById('scoreBoard').innerHTML = '';

        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        loadQuestion();
    }

    function loadQuestion() {
        const q = gameList[currentIdx];
        document.getElementById('questionTitle').textContent = `ç¬¬ ${currentIdx + 1} é¡Œ`;
        document.getElementById('progressText').textContent = `${currentIdx + 1}/20`;
        document.getElementById('chineseHint').textContent = q.ch;
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('resultMessage').className = 'result-message';
        document.getElementById('actionBtn').textContent = 'å®Œæˆ';

        loadWordImage(q.en);

        const container = document.getElementById('letterInputs');
        container.innerHTML = '';

        let inputCount = 0;
        q.en.split('').forEach((char) => {
            if (char === ' ' || char === '-') {
                const s = document.createElement('span');
                s.textContent = char;
                s.style.cssText = 'width:24px;height:58px;display:flex;align-items:center;justify-content:center;';
                container.appendChild(s);
            } else {
                const input = document.createElement('input');
                input.className = 'letter-box';
                input.maxLength = 1;
                input.dataset.index = inputCount++;
                input.addEventListener('input', handleInput);
                input.addEventListener('keydown', handleLetterKeydown);
                container.appendChild(input);
            }
        });

        document.querySelectorAll('.letter-box').forEach(box => {
            box.disabled = false;
            box.className = 'letter-box';
            box.value = '';
        });

        answerChecked = false;
        setTimeout(() => {
            const firstInput = container.querySelector('input');
            if (firstInput) firstInput.focus();
        }, 200);
    }

    function handleInput(e) {
        const input = e.target;
        let value = input.value.toLowerCase().replace(/[^a-z]/g, '');
        input.value = value ? value.toUpperCase() : '';

        if (input.value) {
            const nextIdx = parseInt(input.dataset.index) + 1;
            const nextInput = document.querySelector(`.letter-box[data-index="${nextIdx}"]`);
            if (nextInput) nextInput.focus();
        }
    }

    // æ–¹å‘éµèˆ‡ Backspace è¡Œç‚º
    function handleLetterKeydown(e) {
        const idx = parseInt(e.target.dataset.index);
        if (e.key === 'ArrowLeft') {
            const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
            if (prev) prev.focus();
        } else if (e.key === 'ArrowRight') {
            const next = document.querySelector(`.letter-box[data-index="${idx + 1}"]`);
            if (next) next.focus();
        } else if (e.key === 'Backspace') {
            if (e.target.value) {
                // å·²ç¶“æœ‰å­— â†’ å…ˆåˆªé™¤å­—ï¼Œä¸è‡ªå‹•è·³æ ¼
                e.target.value = '';
            } else {
                // ç©ºçš„ â†’ åˆªé™¤å‰ä¸€æ ¼çš„å­—ä¸¦ç§»å‹•
                const prev = document.querySelector(`.letter-box[data-index="${idx - 1}"]`);
                if (prev) {
                    prev.focus();
                    prev.value = '';
                }
            }
            e.preventDefault();
        }
        // Enter åœ¨å…¨åŸŸ keydown è™•ç†ï¼Œä¸åœ¨é€™è£¡è™•ç†ï¼Œä»¥å…é˜»æ“‹è¼¸å…¥
    }

    function handleAction() {
        if (!answerChecked) {
            checkAnswer();
        } else {
            goNext();
        }
    }

    function checkAnswer() {
        if (answerChecked) return;

        const q = gameList[currentIdx];
        const inputs = document.querySelectorAll('.letter-box');
        let userAns = '', inputIdx = 0;

        q.en.split('').forEach(char => {
            if (char === ' ' || char === '-') userAns += char;
            else userAns += inputs[inputIdx++].value.toLowerCase();
        });

        const isCorrect = userAns === q.en;
        results.push({ q: q.en, ch: q.ch, user: userAns, status: isCorrect });
        scores.push(isCorrect ? 'ğŸ†' : 'ğŸ’€');
        updateScoreBoard();

        inputs.forEach(box => {
            box.disabled = true;
            const correctChar = q.en[parseInt(box.dataset.index)];
            const userChar = box.value.toLowerCase();
            box.classList.add(userChar === correctChar ? 'correct' : 'wrong');
        });

        const resultMsg = document.getElementById('resultMessage');
        if (isCorrect) {
            resultMsg.textContent = 'ğŸ‰ æ­£ç¢ºï¼æŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”';
            resultMsg.className = 'result-message result-correct';
        } else {
            resultMsg.textContent = `âŒ æ­£ç¢ºç­”æ¡ˆï¼š${q.en.toUpperCase()}ï¼ŒæŒ‰ Enter æˆ–é»ã€Œä¸‹ä¸€é¡Œã€ç¹¼çºŒä½œç­”`;
            resultMsg.className = 'result-message result-wrong';
        }

        document.getElementById('actionBtn').textContent = 'ä¸‹ä¸€é¡Œ';
        answerChecked = true;
    }

    function updateScoreBoard() {
        const board = document.getElementById('scoreBoard');
        board.innerHTML = scores.map(score =>
            `<span class="score-icon ${score === 'ğŸ†' ? 'trophy' : 'skull'}">${score}</span>`
        ).join('');
    }

    function pronounceWord() {
        const q = gameList[currentIdx];
        if (!q) return;
        // èªéŸ³æœ¬èº«ä¸æœƒé–ä½è¼¸å…¥ï¼Œåªå»ºç«‹æ–°çš„ Utterance æ’­æ”¾
        const msg = new SpeechSynthesisUtterance(q.en);
        msg.lang = 'en-US';
        msg.rate = 0.8;
        msg.volume = 0.9;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(msg);
        // æ’­æ”¾å¾Œä¸æ”¹è®Š focusï¼Œä¿æŒåœ¨ç›®å‰è¼¸å…¥æ ¼
    }

    function goNext() {
        currentIdx++;
        if (currentIdx < 20) {
            loadQuestion();
        } else {
            showFinalResults();
        }
    }

    function showFinalResults() {
        document.getElementById('gamePanel').classList.remove('active');
        document.getElementById('resultPanel').classList.add('active');
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        results.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = r.q;
            row.insertCell(1).textContent = r.q;
            row.insertCell(2).textContent = r.user || '(æœªå¡«å¯«)';
            const sCell = row.insertCell(3);
            sCell.textContent = r.status ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤';
            sCell.className = r.status ? 'status-correct' : 'status-wrong';
        });
    }
</script>
</body>
</html>
